<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  ï»¿<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <meta name="description" content="Explains Catamorphisms in F#. That means the purpose of fold and foldBack." />
  

  
  <meta name="keywords" content="f#, fsharp, functional, programming, catamorphisms, fold, foldback, foldleft, foldright" />
  

  <title>
    
      Catamorphisms &middot; David Raab
    
  </title>

  <!-- Twitter Card -->
  

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/styles.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/tips.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/public/favicon/apple-touch-icon.png?v=XBr3BkNgXe">
  <link rel="icon" type="image/png" href="/public/favicon/favicon-32x32.png?v=XBr3BkNgXe" sizes="32x32">
  <link rel="icon" type="image/png" href="/public/favicon/favicon-16x16.png?v=XBr3BkNgXe" sizes="16x16">
  <link rel="manifest" href="/public/favicon/manifest.json?v=XBr3BkNgXe">
  <link rel="mask-icon" href="/public/favicon/safari-pinned-tab.svg?v=XBr3BkNgXe" color="#6699ff">
  <link rel="shortcut icon" href="/public/favicon/favicon.ico?v=XBr3BkNgXe">
  <meta name="apple-mobile-web-app-title" content="David Raab">
  <meta name="application-name" content="David Raab">
  <meta name="msapplication-config" content="/public/favicon/browserconfig.xml?v=XBr3BkNgXe">
  <meta name="theme-color" content="#ff0000">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- JS -->
  <script type="text/javascript" src="/public/js/tips.js"></script>
</head>

  <body>
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h2>
        <a href="/">
          David Raab
        </a>
      </h2>
      <p class="lead"></p>
    </div>

      <nav class="sidebar-nav">
          <a class="sidebar-nav-item" href="/">Home</a>
          <a class="sidebar-nav-item" href="/Series">Series</a>
          <a class="sidebar-nav-item" href="/Links">External Links</a>
          <a class="sidebar-nav-item" href="/tags">Tags</a>
          <a class="sidebar-nav-item" href="/archive">Archive</a>
          <a class="sidebar-nav-item" href="/atom.xml">RSS</a>
      </nav>
      <div>
          <a href="https://github.com/sidburn/sidburn.github.io">
              <img src="/public/GitHub-Mark-Light-32px.png" style="display: inline" />
          </a>
          <a href="https://twitter.com/David_Raab">
              <img src="/public/Twitter_logo_white_32.png" style="display: inline" />
          </a>
          <a href="http://stackoverflow.com/users/338059/sid-burn">
              <img src="/public/so-icon.png" style="display: inline" />
          </a>
      </div>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Catamorphisms</h1>
  <div class="post-header">
    <span class="post-date">28 May 2016</span>
    <span class="post-tags">
  
  
  <a class="tag" href="/tags/#F#">F#</a>
  
  <a class="tag" href="/tags/#fold">fold</a>
  
  <a class="tag" href="/tags/#list">list</a>
  
  <a class="tag" href="/tags/#data">data</a>
  
  <a class="tag" href="/tags/#types">types</a>
  
  <a class="tag" href="/tags/#recursion">recursion</a>
  
</span>

  </div>

  <p>Up to this point I created various articles about <code>fold</code>, in my <a href="/Series">Series</a> I
also created a category named <strong>Fold (Catamorphisms)</strong> but up till now I didn't explained
how this articles related to each other, or what <em>Catamorphisms</em> mean. In this article
I want to talk about the remaining parts.</p>
<h2>Table of Content</h2>
<ul class="toc">
  <li><a href="#TheLists">The List</a></li>
    <ul>
      <li><a href="#cata">Introducing Cata</a></li>
      <li><a href="#tail-recursion">Tail Recursion with FoldBack</a></li>
    </ul>
  <li><a href="#binary-trees">Binary Trees</a></li>
    <ul>
      <li><a href="#tree-cata">Cata for Tree</a></li>
      <li><a href="#fold-vs-foldback">Fold vs. FoldBack</a></li>
      <li><a href="#tree-foldback">FoldBack for Tree</a></li>
      <li><a href="#tree-foldback-examples">FoldBack examples</a></li>
      <li><a href="#tree-fold">Fold for Tree</a></li>
      <li><a href="#benchmarking">Some Benchmarking</a></li>
    </ul>
  <li><a href="#markdown">Markdown</a></li>
  <li><a href="#summary">Summary</a></li>
  <li><a href="#further">Further Reading</a></li>
  <li><a href="#comments">Comments</a></li>
</ul>
<a name="TheLists"></a>
<h2>The List</h2>
<p>Catamorphisms is a generalization that emerged from the list data-structure. The list
data-structure, how it is found in functional programming, is usually build as a single
linked list. Or to be more precise, it is build as a recursive data type expressed
as a Discriminated Union. That is the reason why
<a href="/blog/2016/04/26/algebraic-data-types">Algebraic Data-Types</a> is the very first
entry.</p>
<p>Catamorphisms is the idea that we also implement <code>fold</code> and <code>foldBack</code> functions for
other discriminated unions besides list. Because of this it is important to first
understand how to define data-types, especially recursive discriminated unions.</p>
<p>To get a better understanding of the concept, this time we implement our own
list type.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="t">List</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span>
    | <span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="p">Empty</span>
    | <span onmouseout="hideTip(event, 'fs6', 6)" onmouseover="showTip(event, 'fs6', 6)" class="p">Cons</span> <span class="k">of</span> <span class="i">head</span><span class="o">:</span><span class="o">&#39;</span><span class="i">a</span> <span class="o">*</span> <span class="i">tail</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs4', 7)" onmouseover="showTip(event, 'fs4', 7)" class="t">List</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>
<p>I also create additionally constructor functions for each case:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">empty</span>    <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 9)" onmouseover="showTip(event, 'fs5', 9)" class="p">Empty</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 10)" onmouseover="showTip(event, 'fs8', 10)" class="f">cons</span> <span onmouseout="hideTip(event, 'fs9', 11)" onmouseover="showTip(event, 'fs9', 11)" class="i">h</span> <span onmouseout="hideTip(event, 'fs10', 12)" onmouseover="showTip(event, 'fs10', 12)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs6', 13)" onmouseover="showTip(event, 'fs6', 13)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 14)" onmouseover="showTip(event, 'fs9', 14)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 15)" onmouseover="showTip(event, 'fs10', 15)" class="i">t</span>)
</code></pre></td>
</tr>
</table>
<div class="info">
When you wonder about the name <code>Cons</code> this dates back to Lisp. For example
in <a href="http://www.racket-lang.org/">Racket</a> (a Lisp dialect) you can
build a list in such way.
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="racket">(define xs (cons 1 (cons 2 (cons 3 empty))))
</code></pre></td></tr></table>
<p>with the helper functions we defined in F# it almost looks the same.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs11', 16)" onmouseover="showTip(event, 'fs11', 16)" class="i">xs</span> <span class="o">=</span> (<span class="i">cons</span> <span class="n">1</span> (<span class="i">cons</span> <span class="n">2</span> (<span class="i">cons</span> <span class="n">3</span> <span class="i">empty</span>)))
</code></pre></td>
</tr>
</table>
</div>
<p>As soon we have any kind of discriminated union, working with such a type follows
a straight pattern. Usually we create a function that matches on our type, and
we must provide code for every case we have. In our list case that means
we must match on the <code>Empty</code> case and on the <code>Cons(h,t)</code> case and do something
with every case.</p>
<p>But the <code>Cons</code> case is special, because it is recursive. So how do we work
with it? We just write a recursive function that recurs! Once you notice
this pattern, writing any kind of function for a recursive discriminated union
becomes easy. First, let's define some example data that we will use from now on:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs12', 17)" onmouseover="showTip(event, 'fs12', 17)" class="i">l1</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs8', 18)" onmouseover="showTip(event, 'fs8', 18)" class="f">cons</span> <span class="n">1</span> (<span onmouseout="hideTip(event, 'fs8', 19)" onmouseover="showTip(event, 'fs8', 19)" class="f">cons</span> <span class="n">2</span> (<span onmouseout="hideTip(event, 'fs8', 20)" onmouseover="showTip(event, 'fs8', 20)" class="f">cons</span> <span class="n">3</span> <span onmouseout="hideTip(event, 'fs7', 21)" onmouseover="showTip(event, 'fs7', 21)" class="i">empty</span>)))
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs13', 22)" onmouseover="showTip(event, 'fs13', 22)" class="i">l2</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs8', 23)" onmouseover="showTip(event, 'fs8', 23)" class="f">cons</span> <span class="n">1</span> (<span onmouseout="hideTip(event, 'fs8', 24)" onmouseover="showTip(event, 'fs8', 24)" class="f">cons</span> <span class="n">2</span> (<span onmouseout="hideTip(event, 'fs8', 25)" onmouseover="showTip(event, 'fs8', 25)" class="f">cons</span> <span class="n">3</span> (<span onmouseout="hideTip(event, 'fs8', 26)" onmouseover="showTip(event, 'fs8', 26)" class="f">cons</span> <span class="n">4</span> (<span onmouseout="hideTip(event, 'fs8', 27)" onmouseover="showTip(event, 'fs8', 27)" class="f">cons</span> <span class="n">5</span> <span onmouseout="hideTip(event, 'fs7', 28)" onmouseover="showTip(event, 'fs7', 28)" class="i">empty</span>)))))
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs14', 29)" onmouseover="showTip(event, 'fs14', 29)" class="i">l3</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs8', 30)" onmouseover="showTip(event, 'fs8', 30)" class="f">cons</span> <span class="s">&quot;Hello&quot;</span> (<span onmouseout="hideTip(event, 'fs8', 31)" onmouseover="showTip(event, 'fs8', 31)" class="f">cons</span> <span class="s">&quot; &quot;</span> (<span onmouseout="hideTip(event, 'fs8', 32)" onmouseover="showTip(event, 'fs8', 32)" class="f">cons</span> <span class="s">&quot;World!&quot;</span> <span onmouseout="hideTip(event, 'fs7', 33)" onmouseover="showTip(event, 'fs7', 33)" class="i">empty</span>)))
</code></pre></td>
</tr>
</table>
<p>And our first example function <code>listLength'</code></p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs15', 34)" onmouseover="showTip(event, 'fs15', 34)" class="f">listLength&#39;</span> <span onmouseout="hideTip(event, 'fs16', 35)" onmouseover="showTip(event, 'fs16', 35)" class="i">list</span> <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs16', 36)" onmouseover="showTip(event, 'fs16', 36)" class="i">list</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs5', 37)" onmouseover="showTip(event, 'fs5', 37)" class="p">Empty</span>     <span class="k">-&gt;</span> <span class="n">0</span>
    | <span onmouseout="hideTip(event, 'fs6', 38)" onmouseover="showTip(event, 'fs6', 38)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 39)" onmouseover="showTip(event, 'fs9', 39)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 40)" onmouseover="showTip(event, 'fs10', 40)" class="i">t</span>) <span class="k">-&gt;</span> <span class="n">1</span> <span class="o">+</span> (<span onmouseout="hideTip(event, 'fs15', 41)" onmouseover="showTip(event, 'fs15', 41)" class="f">listLength&#39;</span> <span onmouseout="hideTip(event, 'fs10', 42)" onmouseover="showTip(event, 'fs10', 42)" class="i">t</span>)

<span onmouseout="hideTip(event, 'fs15', 43)" onmouseover="showTip(event, 'fs15', 43)" class="f">listLength&#39;</span> <span onmouseout="hideTip(event, 'fs12', 44)" onmouseover="showTip(event, 'fs12', 44)" class="i">l1</span> <span class="c">// 3</span>
<span onmouseout="hideTip(event, 'fs15', 45)" onmouseover="showTip(event, 'fs15', 45)" class="f">listLength&#39;</span> <span onmouseout="hideTip(event, 'fs13', 46)" onmouseover="showTip(event, 'fs13', 46)" class="i">l2</span> <span class="c">// 5</span>
<span onmouseout="hideTip(event, 'fs15', 47)" onmouseover="showTip(event, 'fs15', 47)" class="f">listLength&#39;</span> <span onmouseout="hideTip(event, 'fs14', 48)" onmouseover="showTip(event, 'fs14', 48)" class="i">l3</span> <span class="c">// 3</span>
</code></pre></td>
</tr>
</table>
<p><code>listLength'</code> returns the amount of elements in our list. We just need to handle
both cases to achieve that. If we have an <code>Empty</code> case, the length is obvious,
then we have zero elements. If we have <code>Cons</code> then we have one element plus
the amount of elements of the remaining list. So we call <code>listLength' t</code> to
get it.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs17', 49)" onmouseover="showTip(event, 'fs17', 49)" class="f">listSum&#39;</span> <span class="o">=</span> <span class="k">function</span>
    | <span onmouseout="hideTip(event, 'fs5', 50)" onmouseover="showTip(event, 'fs5', 50)" class="p">Empty</span>     <span class="k">-&gt;</span> <span class="n">0</span>
    | <span onmouseout="hideTip(event, 'fs6', 51)" onmouseover="showTip(event, 'fs6', 51)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs18', 52)" onmouseover="showTip(event, 'fs18', 52)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs19', 53)" onmouseover="showTip(event, 'fs19', 53)" class="i">t</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs18', 54)" onmouseover="showTip(event, 'fs18', 54)" class="i">h</span> <span class="o">+</span> (<span onmouseout="hideTip(event, 'fs17', 55)" onmouseover="showTip(event, 'fs17', 55)" class="f">listSum&#39;</span> <span onmouseout="hideTip(event, 'fs19', 56)" onmouseover="showTip(event, 'fs19', 56)" class="i">t</span>)

<span onmouseout="hideTip(event, 'fs17', 57)" onmouseover="showTip(event, 'fs17', 57)" class="f">listSum&#39;</span> <span onmouseout="hideTip(event, 'fs12', 58)" onmouseover="showTip(event, 'fs12', 58)" class="i">l1</span> <span class="c">// 6</span>
<span onmouseout="hideTip(event, 'fs17', 59)" onmouseover="showTip(event, 'fs17', 59)" class="f">listSum&#39;</span> <span onmouseout="hideTip(event, 'fs13', 60)" onmouseover="showTip(event, 'fs13', 60)" class="i">l2</span> <span class="c">// 15</span>
</code></pre></td>
</tr>
</table>
<div class="info">
The keyword <code>function</code> is a shortcut. Instead of defining the last argument
and Pattern Match on it. We can directly use <code>function</code> that does the same.
This way we can omit the argument, and the <code>match</code> line.
</div
<p><code>listSum'</code> is just a simple <em>sum</em> function that adds a list of <code>int</code> together.
Probably at this time you start to see that <code>listLength'</code> and <code>listSum'</code> are
very similar. But let's create some more examples.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs20', 61)" onmouseover="showTip(event, 'fs20', 61)" class="f">listMap&#39;</span> <span onmouseout="hideTip(event, 'fs21', 62)" onmouseover="showTip(event, 'fs21', 62)" class="f">f</span> <span class="o">=</span> <span class="k">function</span>
    | <span onmouseout="hideTip(event, 'fs5', 63)" onmouseover="showTip(event, 'fs5', 63)" class="p">Empty</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs7', 64)" onmouseover="showTip(event, 'fs7', 64)" class="i">empty</span>
    | <span onmouseout="hideTip(event, 'fs6', 65)" onmouseover="showTip(event, 'fs6', 65)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 66)" onmouseover="showTip(event, 'fs9', 66)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 67)" onmouseover="showTip(event, 'fs10', 67)" class="i">t</span>) <span class="k">-&gt;</span> (<span onmouseout="hideTip(event, 'fs8', 68)" onmouseover="showTip(event, 'fs8', 68)" class="f">cons</span> (<span onmouseout="hideTip(event, 'fs21', 69)" onmouseover="showTip(event, 'fs21', 69)" class="f">f</span> <span onmouseout="hideTip(event, 'fs9', 70)" onmouseover="showTip(event, 'fs9', 70)" class="i">h</span>) (<span onmouseout="hideTip(event, 'fs20', 71)" onmouseover="showTip(event, 'fs20', 71)" class="f">listMap&#39;</span> <span onmouseout="hideTip(event, 'fs21', 72)" onmouseover="showTip(event, 'fs21', 72)" class="f">f</span> <span onmouseout="hideTip(event, 'fs10', 73)" onmouseover="showTip(event, 'fs10', 73)" class="i">t</span>))

<span onmouseout="hideTip(event, 'fs20', 74)" onmouseover="showTip(event, 'fs20', 74)" class="f">listMap&#39;</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 75)" onmouseover="showTip(event, 'fs22', 75)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 76)" onmouseover="showTip(event, 'fs22', 76)" class="i">x</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs22', 77)" onmouseover="showTip(event, 'fs22', 77)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs12', 78)" onmouseover="showTip(event, 'fs12', 78)" class="i">l1</span> <span class="c">// Cons (1,Cons (4,Cons (9,Empty)))</span>
<span onmouseout="hideTip(event, 'fs20', 79)" onmouseover="showTip(event, 'fs20', 79)" class="f">listMap&#39;</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 80)" onmouseover="showTip(event, 'fs22', 80)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 81)" onmouseover="showTip(event, 'fs22', 81)" class="i">x</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs22', 82)" onmouseover="showTip(event, 'fs22', 82)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs13', 83)" onmouseover="showTip(event, 'fs13', 83)" class="i">l2</span> <span class="c">// Cons (1,Cons (4,Cons (9,Cons (16,Cons (25,Empty)))))</span>
<span onmouseout="hideTip(event, 'fs20', 84)" onmouseover="showTip(event, 'fs20', 84)" class="f">listMap&#39;</span> <span onmouseout="hideTip(event, 'fs23', 85)" onmouseover="showTip(event, 'fs23', 85)" class="t">String</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs24', 86)" onmouseover="showTip(event, 'fs24', 86)" class="f">length</span> <span onmouseout="hideTip(event, 'fs14', 87)" onmouseover="showTip(event, 'fs14', 87)" class="i">l3</span>    <span class="c">// Cons (5,Cons (1,Cons (6,Empty)))</span>
</code></pre></td>
</tr>
</table>
<p>If you are not used to recursion then this looks a little bit more complicated, but it
is still the same. We expect that <code>map</code> runs a function on every element. So what do
we do we do with an empty list? We just return empty. Otherwise we have a single
element <code>h</code> and another list <code>t</code>. In that case we just call <code>(f h)</code> to transform
our <code>h</code> element, and how do we transform the remaining list <code>t</code>? With <code>listMap'</code>,
we only need to <code>cons</code> the result of both function calls.</p>
<p>In the next function we want to append an element to a list. Just think for a
moment for yourself how you achieve that. The answer: In the <code>Cons</code> case we do nothing, as
this is not the end of the list. Instead we transform an <code>Empty</code> with our element
appended.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs25', 88)" onmouseover="showTip(event, 'fs25', 88)" class="f">listSnoc&#39;</span> <span onmouseout="hideTip(event, 'fs26', 89)" onmouseover="showTip(event, 'fs26', 89)" class="i">x</span> <span class="o">=</span> <span class="k">function</span>
    | <span onmouseout="hideTip(event, 'fs5', 90)" onmouseover="showTip(event, 'fs5', 90)" class="p">Empty</span>     <span class="k">-&gt;</span> (<span onmouseout="hideTip(event, 'fs8', 91)" onmouseover="showTip(event, 'fs8', 91)" class="f">cons</span> <span onmouseout="hideTip(event, 'fs26', 92)" onmouseover="showTip(event, 'fs26', 92)" class="i">x</span> <span onmouseout="hideTip(event, 'fs7', 93)" onmouseover="showTip(event, 'fs7', 93)" class="i">empty</span>)
    | <span onmouseout="hideTip(event, 'fs6', 94)" onmouseover="showTip(event, 'fs6', 94)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 95)" onmouseover="showTip(event, 'fs9', 95)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 96)" onmouseover="showTip(event, 'fs10', 96)" class="i">t</span>) <span class="k">-&gt;</span> (<span onmouseout="hideTip(event, 'fs8', 97)" onmouseover="showTip(event, 'fs8', 97)" class="f">cons</span> <span onmouseout="hideTip(event, 'fs9', 98)" onmouseover="showTip(event, 'fs9', 98)" class="i">h</span> (<span onmouseout="hideTip(event, 'fs25', 99)" onmouseover="showTip(event, 'fs25', 99)" class="f">listSnoc&#39;</span> <span onmouseout="hideTip(event, 'fs26', 100)" onmouseover="showTip(event, 'fs26', 100)" class="i">x</span> <span onmouseout="hideTip(event, 'fs10', 101)" onmouseover="showTip(event, 'fs10', 101)" class="i">t</span>))

<span onmouseout="hideTip(event, 'fs25', 102)" onmouseover="showTip(event, 'fs25', 102)" class="f">listSnoc&#39;</span> <span class="n">4</span> <span onmouseout="hideTip(event, 'fs12', 103)" onmouseover="showTip(event, 'fs12', 103)" class="i">l1</span>        <span class="c">// Cons (1,Cons (2,Cons (3,Cons (4,Empty))))</span>
<span onmouseout="hideTip(event, 'fs25', 104)" onmouseover="showTip(event, 'fs25', 104)" class="f">listSnoc&#39;</span> <span class="s">&quot;Kazom!&quot;</span> <span onmouseout="hideTip(event, 'fs14', 105)" onmouseover="showTip(event, 'fs14', 105)" class="i">l3</span> <span class="c">// Cons (&quot;Hello&quot;,Cons (&quot; &quot;,Cons (&quot;World!&quot;,Cons (&quot;Kazom!&quot;,Empty))))</span>
</code></pre></td>
</tr>
</table>
<p>Okay, at this point we have enough examples. When we look at our examples, how do we work
with a discriminated union in general? All examples have one recurring pattern that we
do all over again.</p>
<ol>
<li>We must pattern match on every case of the discriminated union.</li>
<li>In a non-recursive case we just do whatever needs to be done.</li>
<li>
In a recursive case like <code>Cons</code> we have two data-fields. <code>h</code> and <code>t</code>. We just work
with <code>h</code> however we need, exactly like a non-recursive case. For the recursive datum
<code>t</code> we just call our function again and recurs.
</li>
</ol>
<p>This is a general pattern how we can work with any discriminated union and provide any
kind of transformation for it. But there can be two problems with this approach:</p>
<ol>
<li>
The function feels repetitive, or more important, always rewriting the whole recursion logic
feels not like Don't-Repeat-Yourself.
</li>
<li>None of the functions we have, are tail-recursive.</li>
</ol>
<p>Let's address those problems separately.</p>
<a name="cata"></a>
<h2>Introducing Cata</h2>
<p>We already identified our Pattern, so what we usually do is to create a <code>cata</code> function
that abstract those repetition. To describe the repetition in one sentence: <em>A <code>cata</code>
function abstracts the recursion over a data-structure.</em></p>
<p>We handle the recursion inside of <code>cata</code>. <code>cata</code> then expects a function to handle
every case. New functions can then be created out of <code>cata</code>.</p>
<div class="info">
Abstraction is probably the most important thing in programming. Abstraction is the idea
to see recurring patterns. That means in order to do abstraction we need at least
two things that are very similar (lets name them A and B). We then create a new function
(we name it C) that contains all the similar things between A and B. To handle the differences
we expect the differences to be passed as arguments to C (Often in the form of functions).
After we have C, we rewrite A and B by using C.
</div>
<p>Our first version of <code>cata</code> could look like this.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs27', 106)" onmouseover="showTip(event, 'fs27', 106)" class="f">listCata&#39;</span> <span onmouseout="hideTip(event, 'fs28', 107)" onmouseover="showTip(event, 'fs28', 107)" class="f">fEmpty</span> <span onmouseout="hideTip(event, 'fs29', 108)" onmouseover="showTip(event, 'fs29', 108)" class="f">fCons</span> <span class="o">=</span> <span class="k">function</span>
    | <span onmouseout="hideTip(event, 'fs5', 109)" onmouseover="showTip(event, 'fs5', 109)" class="p">Empty</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs28', 110)" onmouseover="showTip(event, 'fs28', 110)" class="f">fEmpty</span> ()
    | <span onmouseout="hideTip(event, 'fs6', 111)" onmouseover="showTip(event, 'fs6', 111)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs30', 112)" onmouseover="showTip(event, 'fs30', 112)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs31', 113)" onmouseover="showTip(event, 'fs31', 113)" class="i">t</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs29', 114)" onmouseover="showTip(event, 'fs29', 114)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs30', 115)" onmouseover="showTip(event, 'fs30', 115)" class="i">h</span> (<span onmouseout="hideTip(event, 'fs27', 116)" onmouseover="showTip(event, 'fs27', 116)" class="f">listCata&#39;</span> <span onmouseout="hideTip(event, 'fs28', 117)" onmouseover="showTip(event, 'fs28', 117)" class="f">fEmpty</span> <span onmouseout="hideTip(event, 'fs29', 118)" onmouseover="showTip(event, 'fs29', 118)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs31', 119)" onmouseover="showTip(event, 'fs31', 119)" class="i">t</span>)
</code></pre></td>
</tr>
</table>
<p>Before we look closer in how it works, let's see how we can create a new length function
defined with <code>cata</code> instead.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs32', 120)" onmouseover="showTip(event, 'fs32', 120)" class="f">listLength&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs16', 121)" onmouseover="showTip(event, 'fs16', 121)" class="i">list</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 122)" onmouseover="showTip(event, 'fs27', 122)" class="f">listCata&#39;</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span class="n">0</span>) (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs9', 123)" onmouseover="showTip(event, 'fs9', 123)" class="i">h</span> <span onmouseout="hideTip(event, 'fs33', 124)" onmouseover="showTip(event, 'fs33', 124)" class="i">t</span> <span class="k">-&gt;</span> <span class="n">1</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs33', 125)" onmouseover="showTip(event, 'fs33', 125)" class="i">t</span>) <span onmouseout="hideTip(event, 'fs16', 126)" onmouseover="showTip(event, 'fs16', 126)" class="i">list</span>

<span onmouseout="hideTip(event, 'fs32', 127)" onmouseover="showTip(event, 'fs32', 127)" class="f">listLength&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs12', 128)" onmouseover="showTip(event, 'fs12', 128)" class="i">l1</span> <span class="c">// 3</span>
<span onmouseout="hideTip(event, 'fs32', 129)" onmouseover="showTip(event, 'fs32', 129)" class="f">listLength&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs13', 130)" onmouseover="showTip(event, 'fs13', 130)" class="i">l2</span> <span class="c">// 5</span>
<span onmouseout="hideTip(event, 'fs32', 131)" onmouseover="showTip(event, 'fs32', 131)" class="f">listLength&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs14', 132)" onmouseover="showTip(event, 'fs14', 132)" class="i">l3</span> <span class="c">// 3</span>
</code></pre></td>
</tr>
</table>
<p><code>listCata'</code> just expects two functions. The first functions handles the <code>Empty</code> case,
and the second functions handles the <code>Cons</code> case. But which arguments do we pass those function
exactly?</p>
<p>We pass the data that is attached to every case to the provided function. As the <code>Empty</code> case
don't contain any data, we just call <code>fEmpty ()</code> and pass it the <strong>unit</strong> value.</p>
<p>The <code>Cons</code> case contains two datums. It contains the <em>head</em> and the <em>tail</em> element. But we
do not pass the <em>tail</em> element directly. Just think about it for a minute. The purpose of
the <code>cata</code> function is to abstract the recursion, so the function passed to <code>cata</code>
don't need to handle the recursion. If we would pass <code>t</code> directly to <code>fCons</code> then
<code>fCons</code> again would need to handle the recursion. Instead of passing <code>t</code>, we pass the
result of the recursive call.</p>
<p>If this transformation looks strange. Actually we have written this kind of code multiple
times already. Let's look again at the first <code>listLength'</code> and lets think how we could
transform <code>listLength'</code> to the more abstract <code>listCata'</code>. When we look at the <code>Cons</code> line
It looked like this:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">| <span class="i">Cons</span>(<span class="i">h</span>,<span class="i">t</span>) <span class="k">-&gt;</span> <span class="n">1</span> <span class="o">+</span> (<span class="i">listLength&#39;</span> <span class="i">t</span>)
</code></pre></td>
</tr>
</table>
<p>At first we can treat <code>+</code> just as a function. Instead of writing it infix between two arguments
we also can write it prefix before its arguments. Then it looks like a normal function call.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">|<span class="i">Cons</span>(<span class="i">h</span>,<span class="i">t</span>) <span class="k">-&gt;</span> (<span class="o">+</span>) <span class="n">1</span> (<span class="i">listLength&#39;</span> <span class="i">t</span>)
</code></pre></td>
</tr>
</table>
<p>But in our <code>listCata'</code> function we don't want to calculate <code>(+)</code>, a hard-coded function, we
want to execute the function the user provided, so we write:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">|<span class="i">Cons</span>(<span class="i">h</span>,<span class="i">t</span>) <span class="k">-&gt;</span> <span class="i">fCons</span> <span class="n">1</span> (<span class="i">listLength&#39;</span> <span class="i">t</span>)
</code></pre></td>
</tr>
</table>
<p>Additionally, we don't want to pass <code>1</code>. <code>1</code> was the replacement for <code>h</code> for the length function.
In the abstracted version we just pass <code>h</code> to <code>fCons</code> and <code>fCons</code> decide what to do
with <code>h</code>. And the last thing, our function is named <code>listCata'</code> so we need to recurs on
<code>listCata'</code> not <code>listLength'</code>. So we end with:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">|<span class="i">Cons</span>(<span class="i">h</span>,<span class="i">t</span>) <span class="k">-&gt;</span> <span class="i">fCons</span> <span class="i">h</span> (<span class="i">listCata&#39;</span> <span class="i">fEmpty</span> <span class="i">fCons</span> <span class="i">t</span>)
</code></pre></td>
</tr>
</table>
<p>Now let's improve <code>listCata'</code> step by step. In the list example this isn't so obvious,
but as we see later when we have other discriminated unions with much more cases and a lot
more recursive cases, then calling a <code>cata</code> function can become annoying. We can fix that by
creating a partial applied function before we <code>match</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs34', 133)" onmouseover="showTip(event, 'fs34', 133)" class="f">listCata&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs28', 134)" onmouseover="showTip(event, 'fs28', 134)" class="f">fEmpty</span> <span onmouseout="hideTip(event, 'fs29', 135)" onmouseover="showTip(event, 'fs29', 135)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs35', 136)" onmouseover="showTip(event, 'fs35', 136)" class="i">list</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs36', 137)" onmouseover="showTip(event, 'fs36', 137)" class="f">recurs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 138)" onmouseover="showTip(event, 'fs34', 138)" class="f">listCata&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs28', 139)" onmouseover="showTip(event, 'fs28', 139)" class="f">fEmpty</span> <span onmouseout="hideTip(event, 'fs29', 140)" onmouseover="showTip(event, 'fs29', 140)" class="f">fCons</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs35', 141)" onmouseover="showTip(event, 'fs35', 141)" class="i">list</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs5', 142)" onmouseover="showTip(event, 'fs5', 142)" class="p">Empty</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs28', 143)" onmouseover="showTip(event, 'fs28', 143)" class="f">fEmpty</span> ()
    | <span onmouseout="hideTip(event, 'fs6', 144)" onmouseover="showTip(event, 'fs6', 144)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs30', 145)" onmouseover="showTip(event, 'fs30', 145)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs31', 146)" onmouseover="showTip(event, 'fs31', 146)" class="i">t</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs29', 147)" onmouseover="showTip(event, 'fs29', 147)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs30', 148)" onmouseover="showTip(event, 'fs30', 148)" class="i">h</span> (<span onmouseout="hideTip(event, 'fs36', 149)" onmouseover="showTip(event, 'fs36', 149)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs31', 150)" onmouseover="showTip(event, 'fs31', 150)" class="i">t</span>)
</code></pre></td>
</tr>
</table>
<p>In the case of a list this isn't a big improvement, we also cannot use the <code>function</code> keyword anymore.
But usually it is a good idea and it makes the code a little bit cleaner, especially when we create
a <code>cata</code> function for more complicated discriminated unions.</p>
<p>A second improvement. Actually functions that take <code>unit</code> as a value are bad! A pure function that
expects <code>unit</code> always only can return the exact same value when it is called. F# is not a
pure-functional language, so theoretically <code>fEmpty</code> could do some kind of side-effects and always
return something different. But, I don't encourage such things. A <code>cata</code> function is really
the idea to transform a data-structure, there shouldn't be side-effects in it. So instead
of a function, we just expect a direct value that should be used for the <code>Empty</code> case. On top,
I name the return type <code>'State</code>. This is just a <em>generic-type</em>, but by having a more descriptive
name as <code>'a</code>, <code>'b</code> and so on, it can help in understanding the function signatures. Now our
third <code>listCata'''</code> version looks like this:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs37', 151)" onmouseover="showTip(event, 'fs37', 151)" class="f">listCata&#39;&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs38', 152)" onmouseover="showTip(event, 'fs38', 152)" class="i">empty</span> <span onmouseout="hideTip(event, 'fs39', 153)" onmouseover="showTip(event, 'fs39', 153)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs16', 154)" onmouseover="showTip(event, 'fs16', 154)" class="i">list</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">State</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs40', 155)" onmouseover="showTip(event, 'fs40', 155)" class="f">recurs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs37', 156)" onmouseover="showTip(event, 'fs37', 156)" class="f">listCata&#39;&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs38', 157)" onmouseover="showTip(event, 'fs38', 157)" class="i">empty</span> <span onmouseout="hideTip(event, 'fs39', 158)" onmouseover="showTip(event, 'fs39', 158)" class="f">fCons</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs16', 159)" onmouseover="showTip(event, 'fs16', 159)" class="i">list</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs5', 160)" onmouseover="showTip(event, 'fs5', 160)" class="p">Empty</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs38', 161)" onmouseover="showTip(event, 'fs38', 161)" class="i">empty</span>
    | <span onmouseout="hideTip(event, 'fs6', 162)" onmouseover="showTip(event, 'fs6', 162)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 163)" onmouseover="showTip(event, 'fs9', 163)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 164)" onmouseover="showTip(event, 'fs10', 164)" class="i">t</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs39', 165)" onmouseover="showTip(event, 'fs39', 165)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs9', 166)" onmouseover="showTip(event, 'fs9', 166)" class="i">h</span> (<span onmouseout="hideTip(event, 'fs40', 167)" onmouseover="showTip(event, 'fs40', 167)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs10', 168)" onmouseover="showTip(event, 'fs10', 168)" class="i">t</span>)
</code></pre></td>
</tr>
</table>
<p>When we look at the type-signature of our function the type-signature should look familiar!</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">empty</span><span class="o">:</span><span class="o">&#39;</span><span class="i">State</span> <span class="k">-&gt;</span> <span class="i">fCons</span><span class="o">:</span>(<span class="o">&#39;</span><span class="i">a</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">State</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">State</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs41', 169)" onmouseover="showTip(event, 'fs41', 169)" class="i">list</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs42', 170)" onmouseover="showTip(event, 'fs42', 170)" class="i">List</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">State</span>
</code></pre></td>
</tr>
</table>
<p>It is nearly the same as <code>foldBack</code>! The only difference is that the arguments are in another
order. Let's compare it with the signature of <code>List.foldBack</code>:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">folder</span><span class="o">:</span>(<span class="o">&#39;</span><span class="i">T</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">State</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">State</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs41', 171)" onmouseover="showTip(event, 'fs41', 171)" class="i">list</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs41', 172)" onmouseover="showTip(event, 'fs41', 172)" class="i">list</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">-&gt;</span> <span class="i">state</span><span class="o">:</span><span class="o">&#39;</span><span class="i">State</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">State</span>
</code></pre></td>
</tr>
</table>
<p>It just expects the <code>fCons</code> function first, here named <code>folder</code>, then the list to operator
on, and finally the value for the empty case, here just named <code>state</code>. So let's also
do this kind of re-order, and finally we end up with our final <code>listCata</code> function.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs43', 173)" onmouseover="showTip(event, 'fs43', 173)" class="f">listCata</span> <span onmouseout="hideTip(event, 'fs39', 174)" onmouseover="showTip(event, 'fs39', 174)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs16', 175)" onmouseover="showTip(event, 'fs16', 175)" class="i">list</span> <span onmouseout="hideTip(event, 'fs44', 176)" onmouseover="showTip(event, 'fs44', 176)" class="i">state</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">State</span> <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs16', 177)" onmouseover="showTip(event, 'fs16', 177)" class="i">list</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs5', 178)" onmouseover="showTip(event, 'fs5', 178)" class="p">Empty</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs44', 179)" onmouseover="showTip(event, 'fs44', 179)" class="i">state</span>
    | <span onmouseout="hideTip(event, 'fs6', 180)" onmouseover="showTip(event, 'fs6', 180)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 181)" onmouseover="showTip(event, 'fs9', 181)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 182)" onmouseover="showTip(event, 'fs10', 182)" class="i">t</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs39', 183)" onmouseover="showTip(event, 'fs39', 183)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs9', 184)" onmouseover="showTip(event, 'fs9', 184)" class="i">h</span> (<span onmouseout="hideTip(event, 'fs43', 185)" onmouseover="showTip(event, 'fs43', 185)" class="f">listCata</span> <span onmouseout="hideTip(event, 'fs39', 186)" onmouseover="showTip(event, 'fs39', 186)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs10', 187)" onmouseover="showTip(event, 'fs10', 187)" class="i">t</span> <span onmouseout="hideTip(event, 'fs44', 188)" onmouseover="showTip(event, 'fs44', 188)" class="i">state</span>)
</code></pre></td>
</tr>
</table>
<p>Usually, i wouldn't do such a re-order for a <code>cata</code> function. We also lost the ability
to use partial application with the <code>recurs</code> function. But because our list type is anyway
so small, the re-order doesn't hurt much. Here, it is more an example to show more clearly
the relation that <code>cata</code> always has the same behaviour as <code>foldBack</code>.</p>
<div class="info">
It is important to understand that it behaves like <code>foldBack</code> not like
<code>fold</code>! I will later go more deeply into this topic and show how <code>fold</code>
and <code>foldBack</code> differ, and why that difference is important.
</div>
<p>Our goal why we created a <code>cata</code> function was that we have an abstraction, instead of writing
functions that do the recursion all over by themselves, we now can use <code>listCata</code> that abstract
this kind of thing for us. Now, we also should use <code>listCata</code> and rewrite all our functions
we created so far by using our abstraction. Here are the final list functions re-written with
<code>listCata</code> instead.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs45', 189)" onmouseover="showTip(event, 'fs45', 189)" class="f">listLength</span> <span onmouseout="hideTip(event, 'fs16', 190)" onmouseover="showTip(event, 'fs16', 190)" class="i">list</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs43', 191)" onmouseover="showTip(event, 'fs43', 191)" class="f">listCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 192)" onmouseover="showTip(event, 'fs26', 192)" class="i">x</span> <span onmouseout="hideTip(event, 'fs46', 193)" onmouseover="showTip(event, 'fs46', 193)" class="i">acc</span> <span class="k">-&gt;</span> <span class="n">1</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs46', 194)" onmouseover="showTip(event, 'fs46', 194)" class="i">acc</span>) <span onmouseout="hideTip(event, 'fs16', 195)" onmouseover="showTip(event, 'fs16', 195)" class="i">list</span> <span class="n">0</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs47', 196)" onmouseover="showTip(event, 'fs47', 196)" class="f">listSum</span>    <span onmouseout="hideTip(event, 'fs48', 197)" onmouseover="showTip(event, 'fs48', 197)" class="i">list</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs43', 198)" onmouseover="showTip(event, 'fs43', 198)" class="f">listCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 199)" onmouseover="showTip(event, 'fs22', 199)" class="i">x</span> <span onmouseout="hideTip(event, 'fs46', 200)" onmouseover="showTip(event, 'fs46', 200)" class="i">acc</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 201)" onmouseover="showTip(event, 'fs22', 201)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs46', 202)" onmouseover="showTip(event, 'fs46', 202)" class="i">acc</span>) <span onmouseout="hideTip(event, 'fs48', 203)" onmouseover="showTip(event, 'fs48', 203)" class="i">list</span> <span class="n">0</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs49', 204)" onmouseover="showTip(event, 'fs49', 204)" class="f">listMap</span> <span onmouseout="hideTip(event, 'fs21', 205)" onmouseover="showTip(event, 'fs21', 205)" class="f">f</span>  <span onmouseout="hideTip(event, 'fs16', 206)" onmouseover="showTip(event, 'fs16', 206)" class="i">list</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs43', 207)" onmouseover="showTip(event, 'fs43', 207)" class="f">listCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 208)" onmouseover="showTip(event, 'fs26', 208)" class="i">x</span> <span onmouseout="hideTip(event, 'fs50', 209)" onmouseover="showTip(event, 'fs50', 209)" class="i">acc</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs8', 210)" onmouseover="showTip(event, 'fs8', 210)" class="f">cons</span> (<span onmouseout="hideTip(event, 'fs21', 211)" onmouseover="showTip(event, 'fs21', 211)" class="f">f</span> <span onmouseout="hideTip(event, 'fs26', 212)" onmouseover="showTip(event, 'fs26', 212)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs50', 213)" onmouseover="showTip(event, 'fs50', 213)" class="i">acc</span>) <span onmouseout="hideTip(event, 'fs16', 214)" onmouseover="showTip(event, 'fs16', 214)" class="i">list</span> <span onmouseout="hideTip(event, 'fs7', 215)" onmouseover="showTip(event, 'fs7', 215)" class="i">empty</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs51', 216)" onmouseover="showTip(event, 'fs51', 216)" class="f">listSnoc</span> <span onmouseout="hideTip(event, 'fs26', 217)" onmouseover="showTip(event, 'fs26', 217)" class="i">x</span> <span onmouseout="hideTip(event, 'fs16', 218)" onmouseover="showTip(event, 'fs16', 218)" class="i">list</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs43', 219)" onmouseover="showTip(event, 'fs43', 219)" class="f">listCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 220)" onmouseover="showTip(event, 'fs26', 220)" class="i">x</span> <span onmouseout="hideTip(event, 'fs52', 221)" onmouseover="showTip(event, 'fs52', 221)" class="i">acc</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs8', 222)" onmouseover="showTip(event, 'fs8', 222)" class="f">cons</span> <span onmouseout="hideTip(event, 'fs26', 223)" onmouseover="showTip(event, 'fs26', 223)" class="i">x</span> <span onmouseout="hideTip(event, 'fs52', 224)" onmouseover="showTip(event, 'fs52', 224)" class="i">acc</span>) <span onmouseout="hideTip(event, 'fs16', 225)" onmouseover="showTip(event, 'fs16', 225)" class="i">list</span> (<span onmouseout="hideTip(event, 'fs8', 226)" onmouseover="showTip(event, 'fs8', 226)" class="f">cons</span> <span onmouseout="hideTip(event, 'fs26', 227)" onmouseover="showTip(event, 'fs26', 227)" class="i">x</span> <span onmouseout="hideTip(event, 'fs7', 228)" onmouseover="showTip(event, 'fs7', 228)" class="i">empty</span>)
</code></pre></td>
</tr>
</table>
<p>And some examples to see that they work like expected:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs45', 229)" onmouseover="showTip(event, 'fs45', 229)" class="f">listLength</span> <span onmouseout="hideTip(event, 'fs12', 230)" onmouseover="showTip(event, 'fs12', 230)" class="i">l1</span> <span class="c">// 3</span>
<span onmouseout="hideTip(event, 'fs45', 231)" onmouseover="showTip(event, 'fs45', 231)" class="f">listLength</span> <span onmouseout="hideTip(event, 'fs13', 232)" onmouseover="showTip(event, 'fs13', 232)" class="i">l2</span> <span class="c">// 5</span>
<span onmouseout="hideTip(event, 'fs45', 233)" onmouseover="showTip(event, 'fs45', 233)" class="f">listLength</span> <span onmouseout="hideTip(event, 'fs14', 234)" onmouseover="showTip(event, 'fs14', 234)" class="i">l3</span> <span class="c">// 3</span>
<span onmouseout="hideTip(event, 'fs47', 235)" onmouseover="showTip(event, 'fs47', 235)" class="f">listSum</span> <span onmouseout="hideTip(event, 'fs12', 236)" onmouseover="showTip(event, 'fs12', 236)" class="i">l1</span>    <span class="c">// 6</span>
<span onmouseout="hideTip(event, 'fs47', 237)" onmouseover="showTip(event, 'fs47', 237)" class="f">listSum</span> <span onmouseout="hideTip(event, 'fs13', 238)" onmouseover="showTip(event, 'fs13', 238)" class="i">l2</span>    <span class="c">// 15</span>
<span onmouseout="hideTip(event, 'fs49', 239)" onmouseover="showTip(event, 'fs49', 239)" class="f">listMap</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 240)" onmouseover="showTip(event, 'fs22', 240)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 241)" onmouseover="showTip(event, 'fs22', 241)" class="i">x</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs22', 242)" onmouseover="showTip(event, 'fs22', 242)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs12', 243)" onmouseover="showTip(event, 'fs12', 243)" class="i">l1</span> <span class="c">// Cons (1,Cons (4,Cons (9,Empty)))</span>
<span onmouseout="hideTip(event, 'fs49', 244)" onmouseover="showTip(event, 'fs49', 244)" class="f">listMap</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 245)" onmouseover="showTip(event, 'fs22', 245)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 246)" onmouseover="showTip(event, 'fs22', 246)" class="i">x</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs22', 247)" onmouseover="showTip(event, 'fs22', 247)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs13', 248)" onmouseover="showTip(event, 'fs13', 248)" class="i">l2</span> <span class="c">// Cons (1,Cons (4,Cons (9,Cons (16,Cons (25,Empty)))))</span>
<span onmouseout="hideTip(event, 'fs51', 249)" onmouseover="showTip(event, 'fs51', 249)" class="f">listSnoc</span> <span class="n">4</span> <span onmouseout="hideTip(event, 'fs12', 250)" onmouseover="showTip(event, 'fs12', 250)" class="i">l1</span>        <span class="c">// Cons (1,Cons (2,Cons (3,Cons (4,Empty))))</span>
<span onmouseout="hideTip(event, 'fs51', 251)" onmouseover="showTip(event, 'fs51', 251)" class="f">listSnoc</span> <span class="s">&quot;Kazoom&quot;</span> <span onmouseout="hideTip(event, 'fs14', 252)" onmouseover="showTip(event, 'fs14', 252)" class="i">l3</span> <span class="c">// Cons (&quot;Hello&quot;,Cons (&quot; &quot;,Cons (&quot;World!&quot;,Cons (&quot;Kazoom&quot;,Empty))))</span>
</code></pre></td>
</tr>
</table>
<p>Let's summarize what we have done so far:</p>
<ol>
<li>We usually start with a recursively defined discriminated union.</li>
<li>When we work with such a type, we need to write recursive functions.</li>
<li>
Instead of writing functions with recursion directly, we create a <code>cata</code> function
that abstracts the recursion for us.
</li>
<li>The <code>cata</code> function expects a function for every case.</li>
<li>Cases without data can be simple values instead of functions.</li>
<li>We just pass all data associated with that case to the correct function.</li>
<li>
We don't pass a datum that is recursive to the functions. Those datum must be
first passed to <code>cata</code> itself.
</li>
<li>The behaviour of <code>cata</code> is the same as <code>foldBack</code>.</li>
<li><code>cata</code> is not tail-recursive.</li>
</ol>
<a name="tail-recursion"></a>
<h2>Tail Recursion with FoldBack</h2>
<p>At this point we should ask ourselves if we really need tail-recursion. The answer is
not always <strong>yes</strong>. We really should think of the use-cases we have, and what kind
of data-structure we defined. And in the most cases, the answer is <strong>No</strong>.</p>
<p>It is important to understand that we only run into problems with recursion when we
have a data-structure with a linear depth. In our list example, this is the case.
What does it mean exactly? It means that it is pretty normal to have very deep
recursion, usually a case where every additional element increases the depth by one.</p>
<p>For a single linked list this is the case. A list with 10,000 elements will also
create a stack depth of 10,000. So it is important to create tail-recursive
functions. But does that mean all the work on <code>cata</code> was wasted?</p>
<p>Absolutely not. We just take <code>cata</code> as the starting point and we just try to make
<code>cata</code> tail-recursive. The tail recursive version then is what we call <code>foldBack</code>.</p>
<p>And this leads to the next articles in my series. Converting functions into
tail-recursive functions is a task on its own that needs proper explanation.</p>
<p>One technique that is most often used is the idea of an accumulator. Instead of
doing a calculation once a function finished, we do the calculations immediately and
pass the result to the next function call. I explain this conept in more detail
in: <a href="/blog/2016/04/05/mutable-loops-to-immutability">From mutable loops to immutability</a></p>
<p>Another idea is to use a continuation function, I already provide two articles explaining
the ideas behind this technique. In <a href="/blog/2016/04/16/fold-continuations">Continuations and foldBack</a>
I explain in deep how a tail-recursive <code>foldBack</code> works. And in my article
<a href="/blog/2016/05/07/cps-fold">CPS fold -- fold with early exit</a> I explain
the idea of a continuation function a second time with <code>fold</code>.</p>
<p>But it doesn't mean both ideas are interchangeable. When we directly want to create
a tail-recursive <code>foldBack</code> function then we need to use the continuation-function
approach. We cannot create a tail-recursive <code>foldBack</code> with an accumulator approach.</p>
<p>As I already have three articles on those topics I don't go into much further
detail, so I just provide a quick explanation. We just start with the <code>cata</code> function.
In <code>cata</code> we see something like this:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">| <span class="i">Cons</span>(<span class="i">h</span>,<span class="i">t</span>) <span class="k">-&gt;</span> <span class="i">fCons</span> <span class="i">h</span> (<span class="i">listCata</span> <span class="i">fCons</span> <span class="i">t</span> <span class="i">state</span>)
</code></pre></td>
</tr>
</table>
<p>So, the second argument to <code>fCons</code> is a recursive call. Let's shortly rethink what it does.
It calls the function and it will return some kind of data, this data is then passed to
the <code>fCons</code> function as the second argument. With the continuation approach we just assume
we already have that data. So we just replace every recursive call with some variable
we don't have yet.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">| <span class="i">Cons</span>(<span class="i">h</span>,<span class="i">t</span>) <span class="k">-&gt;</span> <span class="i">fCons</span> <span class="i">h</span> <span class="i">racc</span>
</code></pre></td>
</tr>
</table>
<p>Sure, that wouldn't compile now, because we didn't define <code>racc</code> anywhere, so we wrap it
inside a function, that functions then becomes <code>racc</code> somewhere in the future.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">| <span class="i">Cons</span>(<span class="i">h</span>,<span class="i">t</span>) <span class="k">-&gt;</span> (<span class="k">fun</span> <span class="i">racc</span> <span class="k">-&gt;</span> <span class="i">fCons</span> <span class="i">h</span> <span class="i">racc</span>)
</code></pre></td>
</tr>
</table>
<p>But that isn't anything, we still need to somehow traverse our list, and call that function.
In short, we change our previously defined <code>cata</code> all in all to something like that.
Let's see the <code>cata</code> and <code>foldBack</code> directly to each other.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs43', 173)" onmouseover="showTip(event, 'fs43', 173)" class="f">listCata</span> <span onmouseout="hideTip(event, 'fs39', 174)" onmouseover="showTip(event, 'fs39', 174)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs16', 175)" onmouseover="showTip(event, 'fs16', 175)" class="i">list</span> <span onmouseout="hideTip(event, 'fs44', 176)" onmouseover="showTip(event, 'fs44', 176)" class="i">state</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">State</span> <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs16', 177)" onmouseover="showTip(event, 'fs16', 177)" class="i">list</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs5', 178)" onmouseover="showTip(event, 'fs5', 178)" class="p">Empty</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs44', 179)" onmouseover="showTip(event, 'fs44', 179)" class="i">state</span>
    | <span onmouseout="hideTip(event, 'fs6', 180)" onmouseover="showTip(event, 'fs6', 180)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 181)" onmouseover="showTip(event, 'fs9', 181)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 182)" onmouseover="showTip(event, 'fs10', 182)" class="i">t</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs39', 183)" onmouseover="showTip(event, 'fs39', 183)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs9', 184)" onmouseover="showTip(event, 'fs9', 184)" class="i">h</span> (<span onmouseout="hideTip(event, 'fs43', 185)" onmouseover="showTip(event, 'fs43', 185)" class="f">listCata</span> <span onmouseout="hideTip(event, 'fs39', 186)" onmouseover="showTip(event, 'fs39', 186)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs10', 187)" onmouseover="showTip(event, 'fs10', 187)" class="i">t</span> <span onmouseout="hideTip(event, 'fs44', 188)" onmouseover="showTip(event, 'fs44', 188)" class="i">state</span>)
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs53', 253)" onmouseover="showTip(event, 'fs53', 253)" class="f">listFoldBack</span> <span onmouseout="hideTip(event, 'fs39', 254)" onmouseover="showTip(event, 'fs39', 254)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs16', 255)" onmouseover="showTip(event, 'fs16', 255)" class="i">list</span> <span onmouseout="hideTip(event, 'fs44', 256)" onmouseover="showTip(event, 'fs44', 256)" class="i">state</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">State</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs54', 257)" onmouseover="showTip(event, 'fs54', 257)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs16', 258)" onmouseover="showTip(event, 'fs16', 258)" class="i">list</span> <span onmouseout="hideTip(event, 'fs55', 259)" onmouseover="showTip(event, 'fs55', 259)" class="f">cont</span> <span class="o">=</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs16', 260)" onmouseover="showTip(event, 'fs16', 260)" class="i">list</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs5', 261)" onmouseover="showTip(event, 'fs5', 261)" class="p">Empty</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs55', 262)" onmouseover="showTip(event, 'fs55', 262)" class="f">cont</span> <span onmouseout="hideTip(event, 'fs44', 263)" onmouseover="showTip(event, 'fs44', 263)" class="i">state</span>
        | <span onmouseout="hideTip(event, 'fs6', 264)" onmouseover="showTip(event, 'fs6', 264)" class="p">Cons</span>(<span onmouseout="hideTip(event, 'fs9', 265)" onmouseover="showTip(event, 'fs9', 265)" class="i">h</span>,<span onmouseout="hideTip(event, 'fs10', 266)" onmouseover="showTip(event, 'fs10', 266)" class="i">t</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs54', 267)" onmouseover="showTip(event, 'fs54', 267)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs10', 268)" onmouseover="showTip(event, 'fs10', 268)" class="i">t</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs56', 269)" onmouseover="showTip(event, 'fs56', 269)" class="i">racc</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs55', 270)" onmouseover="showTip(event, 'fs55', 270)" class="f">cont</span> (<span onmouseout="hideTip(event, 'fs39', 271)" onmouseover="showTip(event, 'fs39', 271)" class="f">fCons</span> <span onmouseout="hideTip(event, 'fs9', 272)" onmouseover="showTip(event, 'fs9', 272)" class="i">h</span> <span onmouseout="hideTip(event, 'fs56', 273)" onmouseover="showTip(event, 'fs56', 273)" class="i">racc</span>))
    <span onmouseout="hideTip(event, 'fs54', 274)" onmouseover="showTip(event, 'fs54', 274)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs16', 275)" onmouseover="showTip(event, 'fs16', 275)" class="i">list</span> <span onmouseout="hideTip(event, 'fs57', 276)" onmouseover="showTip(event, 'fs57', 276)" class="f">id</span>
</code></pre></td>
</tr>
</table>
<p>The implementation of our list functions also didn't change at all. Instead of
<code>listCata</code> they just use <code>listFoldBack</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">listLength</span> <span onmouseout="hideTip(event, 'fs41', 277)" onmouseover="showTip(event, 'fs41', 277)" class="i">list</span> <span class="o">=</span> <span class="i">listFoldBack</span> (<span class="k">fun</span> <span class="i">x</span> <span class="i">acc</span> <span class="k">-&gt;</span> <span class="n">1</span> <span class="o">+</span> <span class="i">acc</span>) <span onmouseout="hideTip(event, 'fs41', 278)" onmouseover="showTip(event, 'fs41', 278)" class="i">list</span> <span class="n">0</span>
<span class="k">let</span> <span class="i">listSum</span>    <span onmouseout="hideTip(event, 'fs41', 279)" onmouseover="showTip(event, 'fs41', 279)" class="i">list</span> <span class="o">=</span> <span class="i">listFoldBack</span> (<span class="k">fun</span> <span class="i">x</span> <span class="i">acc</span> <span class="k">-&gt;</span> <span class="i">x</span> <span class="o">+</span> <span class="i">acc</span>) <span onmouseout="hideTip(event, 'fs41', 280)" onmouseover="showTip(event, 'fs41', 280)" class="i">list</span> <span class="n">0</span>
<span class="k">let</span> <span class="i">listMap</span> <span class="i">f</span>  <span onmouseout="hideTip(event, 'fs41', 281)" onmouseover="showTip(event, 'fs41', 281)" class="i">list</span> <span class="o">=</span> <span class="i">listFoldBack</span> (<span class="k">fun</span> <span class="i">x</span> <span class="i">acc</span> <span class="k">-&gt;</span> <span class="i">cons</span> (<span class="i">f</span> <span class="i">x</span>) <span class="i">acc</span>) <span onmouseout="hideTip(event, 'fs41', 282)" onmouseover="showTip(event, 'fs41', 282)" class="i">list</span> <span class="i">empty</span>
<span class="k">let</span> <span class="i">listSnoc</span> <span class="i">x</span> <span onmouseout="hideTip(event, 'fs41', 283)" onmouseover="showTip(event, 'fs41', 283)" class="i">list</span> <span class="o">=</span> <span class="i">listFoldBack</span> (<span class="k">fun</span> <span class="i">x</span> <span class="i">acc</span> <span class="k">-&gt;</span> <span class="i">cons</span> <span class="i">x</span> <span class="i">acc</span>) <span onmouseout="hideTip(event, 'fs41', 284)" onmouseover="showTip(event, 'fs41', 284)" class="i">list</span> (<span class="i">cons</span> <span class="i">x</span> <span class="i">empty</span>)
</code></pre></td>
</tr>
</table>
<a name="binary-trees"></a>
<h2>Binary Trees</h2>
<p>Up so far we explored the concept of the <code>cata</code> function only with the list and when we make that
function tail-recursive we call it <code>foldBack</code>. But as said before, Catamorphisms are a generalization.
That means, the concept of writing a <code>cata</code> function and creating tail-recursive version out of it
should also be done for other discriminated unions, not just for a list.</p>
<p>For the next example we will look at a binary tree. A binary tree is quite interesting
because it is very similar to a list. But let's see that in more detail:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs58', 285)" onmouseover="showTip(event, 'fs58', 285)" class="t">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span>
    | <span onmouseout="hideTip(event, 'fs59', 286)" onmouseover="showTip(event, 'fs59', 286)" class="p">Leaf</span>
    | <span onmouseout="hideTip(event, 'fs60', 287)" onmouseover="showTip(event, 'fs60', 287)" class="p">Node</span> <span class="k">of</span> <span class="o">&#39;</span><span class="i">a</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs58', 288)" onmouseover="showTip(event, 'fs58', 288)" class="t">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs58', 289)" onmouseover="showTip(event, 'fs58', 289)" class="t">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>
<p>Once again I also introduce some helper functions to create the cases.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs61', 290)" onmouseover="showTip(event, 'fs61', 290)" class="f">node</span> <span onmouseout="hideTip(event, 'fs26', 291)" onmouseover="showTip(event, 'fs26', 291)" class="i">x</span> <span onmouseout="hideTip(event, 'fs62', 292)" onmouseover="showTip(event, 'fs62', 292)" class="i">l</span> <span onmouseout="hideTip(event, 'fs63', 293)" onmouseover="showTip(event, 'fs63', 293)" class="i">r</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs60', 294)" onmouseover="showTip(event, 'fs60', 294)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs26', 295)" onmouseover="showTip(event, 'fs26', 295)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs62', 296)" onmouseover="showTip(event, 'fs62', 296)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs63', 297)" onmouseover="showTip(event, 'fs63', 297)" class="i">r</span>)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs64', 298)" onmouseover="showTip(event, 'fs64', 298)" class="f">endNode</span> <span onmouseout="hideTip(event, 'fs26', 299)" onmouseover="showTip(event, 'fs26', 299)" class="i">x</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs61', 300)" onmouseover="showTip(event, 'fs61', 300)" class="f">node</span> <span onmouseout="hideTip(event, 'fs26', 301)" onmouseover="showTip(event, 'fs26', 301)" class="i">x</span> <span onmouseout="hideTip(event, 'fs59', 302)" onmouseover="showTip(event, 'fs59', 302)" class="p">Leaf</span> <span onmouseout="hideTip(event, 'fs59', 303)" onmouseover="showTip(event, 'fs59', 303)" class="p">Leaf</span>
</code></pre></td>
</tr>
</table>
<p>And a simple tree that contains the numbers 1 to 7 ordered.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs65', 304)" onmouseover="showTip(event, 'fs65', 304)" class="i">tree</span> <span class="o">=</span>
    (<span onmouseout="hideTip(event, 'fs61', 305)" onmouseover="showTip(event, 'fs61', 305)" class="f">node</span> <span class="n">4</span>
        (<span onmouseout="hideTip(event, 'fs61', 306)" onmouseover="showTip(event, 'fs61', 306)" class="f">node</span> <span class="n">2</span> (<span onmouseout="hideTip(event, 'fs64', 307)" onmouseover="showTip(event, 'fs64', 307)" class="f">endNode</span> <span class="n">1</span>) (<span onmouseout="hideTip(event, 'fs64', 308)" onmouseover="showTip(event, 'fs64', 308)" class="f">endNode</span> <span class="n">3</span>))
        (<span onmouseout="hideTip(event, 'fs61', 309)" onmouseover="showTip(event, 'fs61', 309)" class="f">node</span> <span class="n">6</span> (<span onmouseout="hideTip(event, 'fs64', 310)" onmouseover="showTip(event, 'fs64', 310)" class="f">endNode</span> <span class="n">5</span>) (<span onmouseout="hideTip(event, 'fs64', 311)" onmouseover="showTip(event, 'fs64', 311)" class="f">endNode</span> <span class="n">7</span>)))
</code></pre></td>
</tr>
</table>
<p>So, why is a Tree similar to a list? Because the definition is nearly the same. If you look closer
you see that a tree has two cases exactly like a list has. <code>Leaf</code> marks the end exactly like
<code>Empty</code> did for the list. Instead of <code>Cons</code> with two datums, we have <code>Node</code> with three datums.</p>
<p>The only difference between a list and a binary tree is that every element in a list only has one
child, while a binary tree has two child's. Those child's are often named <em>Left</em> and <em>Right</em>.
That's also the reason why I named the variables <code>l</code> and <code>r</code> in the functions.</p>
<a name="tree-cata"></a>
<h2>Cata for Tree</h2>
<p>So, let's start by creating a <code>cata</code> function for our tree.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs66', 312)" onmouseover="showTip(event, 'fs66', 312)" class="f">treeCata&#39;</span> <span onmouseout="hideTip(event, 'fs67', 313)" onmouseover="showTip(event, 'fs67', 313)" class="f">fLeaf</span> <span onmouseout="hideTip(event, 'fs68', 314)" onmouseover="showTip(event, 'fs68', 314)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs69', 315)" onmouseover="showTip(event, 'fs69', 315)" class="i">tree</span> <span class="o">=</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs69', 316)" onmouseover="showTip(event, 'fs69', 316)" class="i">tree</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs59', 317)" onmouseover="showTip(event, 'fs59', 317)" class="p">Leaf</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs67', 318)" onmouseover="showTip(event, 'fs67', 318)" class="f">fLeaf</span> ()
    | <span onmouseout="hideTip(event, 'fs60', 319)" onmouseover="showTip(event, 'fs60', 319)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs70', 320)" onmouseover="showTip(event, 'fs70', 320)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs71', 321)" onmouseover="showTip(event, 'fs71', 321)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs72', 322)" onmouseover="showTip(event, 'fs72', 322)" class="i">r</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs68', 323)" onmouseover="showTip(event, 'fs68', 323)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs70', 324)" onmouseover="showTip(event, 'fs70', 324)" class="i">x</span> (<span onmouseout="hideTip(event, 'fs66', 325)" onmouseover="showTip(event, 'fs66', 325)" class="f">treeCata&#39;</span> <span onmouseout="hideTip(event, 'fs67', 326)" onmouseover="showTip(event, 'fs67', 326)" class="f">fLeaf</span> <span onmouseout="hideTip(event, 'fs68', 327)" onmouseover="showTip(event, 'fs68', 327)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs71', 328)" onmouseover="showTip(event, 'fs71', 328)" class="i">l</span>) (<span onmouseout="hideTip(event, 'fs66', 329)" onmouseover="showTip(event, 'fs66', 329)" class="f">treeCata&#39;</span> <span onmouseout="hideTip(event, 'fs67', 330)" onmouseover="showTip(event, 'fs67', 330)" class="f">fLeaf</span> <span onmouseout="hideTip(event, 'fs68', 331)" onmouseover="showTip(event, 'fs68', 331)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs72', 332)" onmouseover="showTip(event, 'fs72', 332)" class="i">r</span>)
</code></pre></td>
</tr>
</table>
<p>We started by just turning every case into a function. This time we name them <code>fLeaf</code>
and <code>fNode</code>, after the cases. The pattern is the same. The <code>Leaf</code> case has no data, so
we just call <code>fLeaf</code> with the unit value <code>()</code>. We should remember that we can eliminate
the function in a next version.</p>
<p>The difference in the <code>Node</code> case to the previous <code>Cons</code> case in the list is, that we have
three datums. So <code>fNode</code> will also receive three arguments. But the second and third
argument is a tree again. So before we pass those, we need to recursively call <code>treeCata'</code>
on those trees again.</p>
<p>The two recursive calls looks quite long, so we first create a partial applied <code>recurs</code>
function. Now we have:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs73', 333)" onmouseover="showTip(event, 'fs73', 333)" class="f">treeCata&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs67', 334)" onmouseover="showTip(event, 'fs67', 334)" class="f">fLeaf</span> <span onmouseout="hideTip(event, 'fs68', 335)" onmouseover="showTip(event, 'fs68', 335)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs69', 336)" onmouseover="showTip(event, 'fs69', 336)" class="i">tree</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs74', 337)" onmouseover="showTip(event, 'fs74', 337)" class="f">recurs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs73', 338)" onmouseover="showTip(event, 'fs73', 338)" class="f">treeCata&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs67', 339)" onmouseover="showTip(event, 'fs67', 339)" class="f">fLeaf</span> <span onmouseout="hideTip(event, 'fs68', 340)" onmouseover="showTip(event, 'fs68', 340)" class="f">fNode</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs69', 341)" onmouseover="showTip(event, 'fs69', 341)" class="i">tree</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs59', 342)" onmouseover="showTip(event, 'fs59', 342)" class="p">Leaf</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs67', 343)" onmouseover="showTip(event, 'fs67', 343)" class="f">fLeaf</span> ()
    | <span onmouseout="hideTip(event, 'fs60', 344)" onmouseover="showTip(event, 'fs60', 344)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs70', 345)" onmouseover="showTip(event, 'fs70', 345)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs71', 346)" onmouseover="showTip(event, 'fs71', 346)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs72', 347)" onmouseover="showTip(event, 'fs72', 347)" class="i">r</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs68', 348)" onmouseover="showTip(event, 'fs68', 348)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs70', 349)" onmouseover="showTip(event, 'fs70', 349)" class="i">x</span> (<span onmouseout="hideTip(event, 'fs74', 350)" onmouseover="showTip(event, 'fs74', 350)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs71', 351)" onmouseover="showTip(event, 'fs71', 351)" class="i">l</span>) (<span onmouseout="hideTip(event, 'fs74', 352)" onmouseover="showTip(event, 'fs74', 352)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs72', 353)" onmouseover="showTip(event, 'fs72', 353)" class="i">r</span>)
</code></pre></td>
</tr>
</table>
<p>Next, we eliminate the function for the leaf case.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs75', 354)" onmouseover="showTip(event, 'fs75', 354)" class="f">treeCata&#39;&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs76', 355)" onmouseover="showTip(event, 'fs76', 355)" class="i">leaf</span> <span onmouseout="hideTip(event, 'fs68', 356)" onmouseover="showTip(event, 'fs68', 356)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs69', 357)" onmouseover="showTip(event, 'fs69', 357)" class="i">tree</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs74', 358)" onmouseover="showTip(event, 'fs74', 358)" class="f">recurs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs75', 359)" onmouseover="showTip(event, 'fs75', 359)" class="f">treeCata&#39;&#39;&#39;</span> <span onmouseout="hideTip(event, 'fs76', 360)" onmouseover="showTip(event, 'fs76', 360)" class="i">leaf</span> <span onmouseout="hideTip(event, 'fs68', 361)" onmouseover="showTip(event, 'fs68', 361)" class="f">fNode</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs69', 362)" onmouseover="showTip(event, 'fs69', 362)" class="i">tree</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs59', 363)" onmouseover="showTip(event, 'fs59', 363)" class="p">Leaf</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs76', 364)" onmouseover="showTip(event, 'fs76', 364)" class="i">leaf</span>
    | <span onmouseout="hideTip(event, 'fs60', 365)" onmouseover="showTip(event, 'fs60', 365)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs70', 366)" onmouseover="showTip(event, 'fs70', 366)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs71', 367)" onmouseover="showTip(event, 'fs71', 367)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs72', 368)" onmouseover="showTip(event, 'fs72', 368)" class="i">r</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs68', 369)" onmouseover="showTip(event, 'fs68', 369)" class="f">fNode</span> <span onmouseout="hideTip(event, 'fs70', 370)" onmouseover="showTip(event, 'fs70', 370)" class="i">x</span> (<span onmouseout="hideTip(event, 'fs74', 371)" onmouseover="showTip(event, 'fs74', 371)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs71', 372)" onmouseover="showTip(event, 'fs71', 372)" class="i">l</span>) (<span onmouseout="hideTip(event, 'fs74', 373)" onmouseover="showTip(event, 'fs74', 373)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs72', 374)" onmouseover="showTip(event, 'fs72', 374)" class="i">r</span>)
</code></pre></td>
</tr>
</table>
<p>As a tree also only has two cases, and one of them is not a function, we already see that
we already have a signature like <code>foldBack</code>. So let's re-order the function arguments.
Previously I said we loose the ability for the partial applied <code>recurs</code> function. But
we still can write a <code>recurs</code> function. We only need to know which argument changes.</p>
<p>In the code above you see that we call <code>(recurs l)</code> and <code>(recurs r)</code>. So we only want
to pass the next tree it should work on. So we create a <code>recurs</code> function that only
expects the remaining tree. All in one, we now end with:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs77', 375)" onmouseover="showTip(event, 'fs77', 375)" class="f">treeCata</span> <span onmouseout="hideTip(event, 'fs78', 376)" onmouseover="showTip(event, 'fs78', 376)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs79', 377)" onmouseover="showTip(event, 'fs79', 377)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs80', 378)" onmouseover="showTip(event, 'fs80', 378)" class="i">acc</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">State</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs81', 379)" onmouseover="showTip(event, 'fs81', 379)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs82', 380)" onmouseover="showTip(event, 'fs82', 380)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs77', 381)" onmouseover="showTip(event, 'fs77', 381)" class="f">treeCata</span> <span onmouseout="hideTip(event, 'fs78', 382)" onmouseover="showTip(event, 'fs78', 382)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs82', 383)" onmouseover="showTip(event, 'fs82', 383)" class="i">t</span> <span onmouseout="hideTip(event, 'fs80', 384)" onmouseover="showTip(event, 'fs80', 384)" class="i">acc</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs79', 385)" onmouseover="showTip(event, 'fs79', 385)" class="i">tree</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs59', 386)" onmouseover="showTip(event, 'fs59', 386)" class="p">Leaf</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs80', 387)" onmouseover="showTip(event, 'fs80', 387)" class="i">acc</span>
    | <span onmouseout="hideTip(event, 'fs60', 388)" onmouseover="showTip(event, 'fs60', 388)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs26', 389)" onmouseover="showTip(event, 'fs26', 389)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs62', 390)" onmouseover="showTip(event, 'fs62', 390)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs63', 391)" onmouseover="showTip(event, 'fs63', 391)" class="i">r</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs78', 392)" onmouseover="showTip(event, 'fs78', 392)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs26', 393)" onmouseover="showTip(event, 'fs26', 393)" class="i">x</span> (<span onmouseout="hideTip(event, 'fs81', 394)" onmouseover="showTip(event, 'fs81', 394)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs62', 395)" onmouseover="showTip(event, 'fs62', 395)" class="i">l</span>) (<span onmouseout="hideTip(event, 'fs81', 396)" onmouseover="showTip(event, 'fs81', 396)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs63', 397)" onmouseover="showTip(event, 'fs63', 397)" class="i">r</span>)
</code></pre></td>
</tr>
</table>
<p>Let's create a <code>length</code>, <code>sum</code> and a <code>map</code> function with our <code>cata</code> function.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs83', 398)" onmouseover="showTip(event, 'fs83', 398)" class="f">treeLength</span> <span onmouseout="hideTip(event, 'fs79', 399)" onmouseover="showTip(event, 'fs79', 399)" class="i">tree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs77', 400)" onmouseover="showTip(event, 'fs77', 400)" class="f">treeCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 401)" onmouseover="showTip(event, 'fs26', 401)" class="i">x</span> <span onmouseout="hideTip(event, 'fs84', 402)" onmouseover="showTip(event, 'fs84', 402)" class="i">l</span> <span onmouseout="hideTip(event, 'fs85', 403)" onmouseover="showTip(event, 'fs85', 403)" class="i">r</span> <span class="k">-&gt;</span> <span class="n">1</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs84', 404)" onmouseover="showTip(event, 'fs84', 404)" class="i">l</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs85', 405)" onmouseover="showTip(event, 'fs85', 405)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs79', 406)" onmouseover="showTip(event, 'fs79', 406)" class="i">tree</span> <span class="n">0</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs86', 407)" onmouseover="showTip(event, 'fs86', 407)" class="f">treeSum</span>    <span onmouseout="hideTip(event, 'fs87', 408)" onmouseover="showTip(event, 'fs87', 408)" class="i">tree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs77', 409)" onmouseover="showTip(event, 'fs77', 409)" class="f">treeCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 410)" onmouseover="showTip(event, 'fs22', 410)" class="i">x</span> <span onmouseout="hideTip(event, 'fs84', 411)" onmouseover="showTip(event, 'fs84', 411)" class="i">l</span> <span onmouseout="hideTip(event, 'fs85', 412)" onmouseover="showTip(event, 'fs85', 412)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 413)" onmouseover="showTip(event, 'fs22', 413)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs84', 414)" onmouseover="showTip(event, 'fs84', 414)" class="i">l</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs85', 415)" onmouseover="showTip(event, 'fs85', 415)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs87', 416)" onmouseover="showTip(event, 'fs87', 416)" class="i">tree</span> <span class="n">0</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs88', 417)" onmouseover="showTip(event, 'fs88', 417)" class="f">treeMap</span> <span onmouseout="hideTip(event, 'fs21', 418)" onmouseover="showTip(event, 'fs21', 418)" class="f">f</span>  <span onmouseout="hideTip(event, 'fs79', 419)" onmouseover="showTip(event, 'fs79', 419)" class="i">tree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs77', 420)" onmouseover="showTip(event, 'fs77', 420)" class="f">treeCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs26', 421)" onmouseover="showTip(event, 'fs26', 421)" class="i">x</span> <span onmouseout="hideTip(event, 'fs71', 422)" onmouseover="showTip(event, 'fs71', 422)" class="i">l</span> <span onmouseout="hideTip(event, 'fs72', 423)" onmouseover="showTip(event, 'fs72', 423)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs61', 424)" onmouseover="showTip(event, 'fs61', 424)" class="f">node</span> (<span onmouseout="hideTip(event, 'fs21', 425)" onmouseover="showTip(event, 'fs21', 425)" class="f">f</span> <span onmouseout="hideTip(event, 'fs26', 426)" onmouseover="showTip(event, 'fs26', 426)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs71', 427)" onmouseover="showTip(event, 'fs71', 427)" class="i">l</span> <span onmouseout="hideTip(event, 'fs72', 428)" onmouseover="showTip(event, 'fs72', 428)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs79', 429)" onmouseover="showTip(event, 'fs79', 429)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs59', 430)" onmouseover="showTip(event, 'fs59', 430)" class="p">Leaf</span>

<span class="c">// tree was:</span>
<span class="c">// (node 4</span>
<span class="c">//   (node 2 (endNode 1) (endNode 3))</span>
<span class="c">//   (node 6 (endNode 5) (endNode 7)))</span>

<span onmouseout="hideTip(event, 'fs83', 431)" onmouseover="showTip(event, 'fs83', 431)" class="f">treeLength</span> <span onmouseout="hideTip(event, 'fs65', 432)" onmouseover="showTip(event, 'fs65', 432)" class="i">tree</span> <span class="c">// 7</span>
<span onmouseout="hideTip(event, 'fs86', 433)" onmouseover="showTip(event, 'fs86', 433)" class="f">treeSum</span> <span onmouseout="hideTip(event, 'fs65', 434)" onmouseover="showTip(event, 'fs65', 434)" class="i">tree</span>    <span class="c">// 28</span>
<span onmouseout="hideTip(event, 'fs88', 435)" onmouseover="showTip(event, 'fs88', 435)" class="f">treeMap</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 436)" onmouseover="showTip(event, 'fs22', 436)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 437)" onmouseover="showTip(event, 'fs22', 437)" class="i">x</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs22', 438)" onmouseover="showTip(event, 'fs22', 438)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs65', 439)" onmouseover="showTip(event, 'fs65', 439)" class="i">tree</span>
<span class="c">// (node 16</span>
<span class="c">//   (node 4  (endNode 1)  (endNode 9))</span>
<span class="c">//   (node 36 (endNode 25) (endNode 49)))</span>
</code></pre></td>
</tr>
</table>
<a name="fold-vs-foldback"></a>
<h2>Fold vs. FoldBack</h2>
<p>Before we talk about how to turn <code>cata</code> into a tail-recursive function we should talk
about the difference between <code>fold</code> and <code>foldBack</code>. I explained that if we turn <code>cata</code>
into a tail-recursive function we get back <code>foldBack</code>. If I mention <code>cata</code> or <code>foldBack</code>
i use the terms interchangeable. The fact that one is tail-recursive and the other not,
is not important right now, it is more important how they behave.</p>
<p>But it opens up an important question. When we forget for a moment the mechanical
implementation to create the <code>cata</code> function. How do we know how to implement <code>fold</code> and
<code>foldBack</code> and how do we know how they should behave? Or what is anyway the exact
behaviour of <code>fold</code> and <code>foldBack</code>?</p>
<p>If the question is unclear, let's look again at a list and lets see how <code>fold</code>
and <code>foldBack</code> behaves.</p>
<p><img src="/images/2016/catamorphisms/list.svg" alt="Single-Linked list" /></p>
<p>We can visualize a single-linked list like boxes, and every box points to the next element
in the list. Until the last element points to the end <code>Empty</code>. In the visualization above
represented as <code>/</code>.</p>
<p>The functions <code>fold</code> and <code>foldBack</code> are also often named <code>foldLeft</code> and <code>foldRight</code> in
other languages. They are named like this, because they describe how a list will be
traversed. <code>fold</code> (or <code>foldLeft</code>) traverses a list from left-to-right, while <code>foldBack</code>
(or <code>foldRight</code>) traverses the list from right-to-left.</p>
<p>So when we use <code>fold</code> the function we provide <code>fold</code> first sees <code>1</code>, then <code>2</code>, then <code>3</code>
and so on. While when using <code>foldBack</code> we first encounter <code>5</code>, then <code>4</code>, then <code>3</code> and so
on. This is easy to understand.</p>
<p>But how do they anyway translate to something like a binary tree? Our <code>tree</code> that we used
so far looks like this:</p>
<div style="width:50%;margin: 0 auto">
<img src="/images/2016/catamorphisms/tree.svg" alt="Binary Tree" />
</div>
<p>When we think of <code>fold</code> as left-to-right and <code>foldBack</code> as right-to-left, how do we translate
that to a tree? The problem we have, there doesn't exists only one way to traverse a tree.
<a href="https://en.wikipedia.org/wiki/Tree_traversal">There are many way to traverse a tree</a>, and even then the question
is which traversal we identify as <em>left</em> or <em>right</em>.</p>
<p>Up so far I made it easy, as I just said that <code>cata</code> is <code>foldBack</code> without further describing
the idea behind it why that is so. So let's re-look at <code>fold</code> and <code>foldBack</code> for the list
and let's see if we can describe the operation slightly different.</p>
<p>Previously we already noticed that a list and a binary tree are very similar. We can think of
a list that contains one-element and a one recursive argument, or one-child. A binary
tree on the other hand is one-element and two-child's. When we visualize a tree we usually
show the deeper (recursive) layers underneath an element. In the above visualization we
have <code>4</code> and underneath it <code>2</code> and <code>6</code>. But we also can think of a list in such a way.</p>
<div style="width:25%;margin:0 auto">
<img src="/images/2016/catamorphisms/list_as_tree.svg" alt="List as Tree" />
</div>
<p>We have <code>1</code> and we have the recursive child <code>2</code>. Instead of thinking of traversing a list
from left-to-right or right-to-left, we look at the <strong>folder-function</strong>, and we describe
what the <strong>folder-function</strong> sees. So when we sum all elements in a list like this:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs4', 440)" onmouseover="showTip(event, 'fs4', 440)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs89', 441)" onmouseover="showTip(event, 'fs89', 441)" class="f">fold</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs46', 442)" onmouseover="showTip(event, 'fs46', 442)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs22', 443)" onmouseover="showTip(event, 'fs22', 443)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs46', 444)" onmouseover="showTip(event, 'fs46', 444)" class="i">acc</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs22', 445)" onmouseover="showTip(event, 'fs22', 445)" class="i">x</span>) <span class="n">0</span> [<span class="n">1</span>;<span class="n">2</span>;<span class="n">3</span>;<span class="n">4</span>]
</code></pre></td>
</tr>
</table>
<p>What does the <strong>folder-function</strong> <code>(fun acc x -&gt; acc + x)</code> sees exactly? Let's say <code>fold</code>
is at the element <code>1</code>, which values do we have?</p>
<p>We have <code>0</code> and <code>1</code>. Or more precisely, we get the accumulator so-far, and one-element
of our data-structure. What do we see when <code>fold</code> is at element <code>2</code>? We get <code>1</code> and <code>2</code>.
Once again we get the accumulator so far, and the current element.</p>
<p>Generally speaking, with <code>fold</code> we get the current element and an accumulator that
is the combination of all the things we already have seen. When <code>fold</code> hits <code>3</code>,
then we get <code>3</code> and <code>3</code>. The first <code>3</code> the <em>accumulator</em> was computed by the already seen
elements <code>1</code> and <code>2</code> (1 + 2).</p>
<p>We also can think of <code>fold</code> as looping. Because in looping we usually start with some
mutable initial value, and when we loop over a data-structure we combine the current element
with some outer element.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs90', 446)" onmouseover="showTip(event, 'fs90', 446)" class="v">acc</span> <span class="o">=</span> <span class="n">0</span>
<span class="k">for</span> <span onmouseout="hideTip(event, 'fs22', 447)" onmouseover="showTip(event, 'fs22', 447)" class="i">x</span> <span class="k">in</span> [<span class="n">1..</span><span class="n">4</span>] <span class="k">do</span>
    <span onmouseout="hideTip(event, 'fs90', 448)" onmouseover="showTip(event, 'fs90', 448)" class="v">acc</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs90', 449)" onmouseover="showTip(event, 'fs90', 449)" class="v">acc</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs22', 450)" onmouseover="showTip(event, 'fs22', 450)" class="i">x</span>
</code></pre></td>
</tr>
</table>
<p>But when we look at <code>foldBack</code> it behaves differently. When we write:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs4', 451)" onmouseover="showTip(event, 'fs4', 451)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs91', 452)" onmouseover="showTip(event, 'fs91', 452)" class="f">foldBack</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 453)" onmouseover="showTip(event, 'fs22', 453)" class="i">x</span> <span onmouseout="hideTip(event, 'fs46', 454)" onmouseover="showTip(event, 'fs46', 454)" class="i">acc</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 455)" onmouseover="showTip(event, 'fs22', 455)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs46', 456)" onmouseover="showTip(event, 'fs46', 456)" class="i">acc</span>) [<span class="n">1</span>;<span class="n">2</span>;<span class="n">3</span>;<span class="n">4</span>] <span class="n">0</span>
</code></pre></td>
</tr>
</table>
<p>We get the same result, because the order of <code>+</code> operation doesn't matter. But the behaviour
is different. When our <strong>folder-function</strong> hits the element <code>1</code>, which data, do we get?</p>
<p>We get <code>1</code> and <code>9</code>. <code>1</code> is the current element. But what is <code>9</code>? <code>9</code> is the result of the combination
of the child we have at this point. In <code>foldBack</code> we don't get an accumulation of the things
we already have seen, we get the combination of the things we didn't have seen so far!</p>
<p>With <code>foldBack</code> we get the current element, and the combination of all its child elements. When
we hit <code>2</code> for example, then we just see <code>2</code> and <code>7</code>. Because the child of <code>2</code> is <code>3 + 4</code>. But
we didn't see <code>1</code>, because <code>1</code> is on top of <code>2</code>.</p>
<p>All in one we can say that <code>foldBack</code> is a <em>structure-preserving</em> function. We not get
the current element and an accumulation so far, we get the current element including one
value for each child. And with a tree this distinction becomes more clear. When we look again
at our tree.</p>
<div style="width:50%;margin: 0 auto">
<img src="/images/2016/catamorphisms/tree.svg" alt="Binary Tree" />
</div>
<p>Which arguments does the <em>folder-functions</em> sees when we are at the top element <code>4</code>? We see
<code>4</code> the current element, <code>6</code> for the left child (1 + 2 + 3) and <code>18</code> (5 + 6 + 7) for the
<em>right-child</em>. In <code>foldBack</code> we always get the exact same amount of arguments a case has.</p>
<p>The definition of <code>Node</code> was <code>Node of 'a * Tree&lt;'a&gt; * Tree&lt;'a&gt;</code> so we also get three
arguments in the folder function. But instead of two trees, we already get the result
of them. That means, while <code>fold</code> is like iteration/looping, <code>foldBack</code> is like recursion.</p>
<p>Consider how we would write a recursive <code>sum</code> function without <code>cata</code>, the <code>Node</code> case
would look something like that.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">| <span class="i">Node</span>(<span class="i">x</span>,<span class="i">l</span>,<span class="i">r</span>) <span class="k">-&gt;</span> <span class="i">x</span> <span class="o">+</span> (<span class="i">sum</span> <span class="i">l</span>) <span class="o">+</span> (<span class="i">sum</span> <span class="i">r</span>)
</code></pre></td>
</tr>
</table>
<p>As <code>(sum l)</code> is a function call it just starts calculating a value, but when it returns
it contains the sum of the left child. So once <code>(sum l)</code> and <code>(sum r)</code> completes we have
a line like <code>x + y + z</code>. We just add three values together. <code>foldBack</code> is exactly that
behaviour. <code>foldBack</code> always works like recursion. That is why <code>cata</code> is always
like <code>foldBack</code>. <code>foldBack</code> only ensures that we have tail-recursion.</p>
<p>So how does <code>fold</code> for a tree look like? In fact the <em>folder-function</em> only sees <strong>two</strong>
arguments not <strong>three</strong>. Why is that so? Because <code>fold</code> only sees the things it already
have seen.</p>
<p>The <code>Node</code> case only contains a single non-recursive datum. That means the <code>fold</code> function only
sees an accumulator so far and all the current non-recursive elements. For our specified binary
tree that are only two arguments.</p>
<p>But how does <code>fold</code> traverse a tree? The answer is, it doesn't matter. The purpose
of <code>fold</code> is not to provide a specific order. The purpose of <code>fold</code> is just to visit
every element. <code>fold</code> is ideal for things that behave like <a href="/blog/2016/05/24/monoids">Monoids</a>. <code>fold</code>
is in general a good choice if the operation you have doesn't depend on the structure
itself only on the elements itself.</p>
<p>You also can compare <code>fold</code> with <code>foreach</code> in C#. With <code>foreach</code> in C#, you just iterate
through a data-structure. You also can iterate through a dictionary, and you get the
<em>key</em> and <em>value</em> of every element, but you don't get any information of the structure
of the Dictionary itself. When you loop over a dictionary with foreach you just expect
to somehow get all the values, but you don't expect a particular order.</p>
<p>But if you need the additional information of the structure and somehow work with the
full tree, then you must use <code>foldBack</code>. Because of that, <code>foldBack</code> is more powerful than
<code>fold</code> as you always can use <code>foldBack</code> instead of <code>fold</code>. But the reverse is not true.</p>
<a name="tree-foldback"></a>
<h2>FoldBack for Tree</h2>
<p>I will implement <code>foldBack</code> with the Continuation approach, but I don't go into
much detail how the implementation works exactly, you can read more of those
details here:</p>
<ul>
<li><a href="/blog/2016/04/16/fold-continuations">Continuations and foldBack</a></li>
<li><a href="/blog/2016/05/07/cps-fold">CPS Fold -- fold with early exit</a></li>
</ul>
<p>First, we look again at <code>cata</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs77', 375)" onmouseover="showTip(event, 'fs77', 375)" class="f">treeCata</span> <span onmouseout="hideTip(event, 'fs78', 376)" onmouseover="showTip(event, 'fs78', 376)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs79', 377)" onmouseover="showTip(event, 'fs79', 377)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs80', 378)" onmouseover="showTip(event, 'fs80', 378)" class="i">acc</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">State</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs81', 379)" onmouseover="showTip(event, 'fs81', 379)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs82', 380)" onmouseover="showTip(event, 'fs82', 380)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs77', 381)" onmouseover="showTip(event, 'fs77', 381)" class="f">treeCata</span> <span onmouseout="hideTip(event, 'fs78', 382)" onmouseover="showTip(event, 'fs78', 382)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs82', 383)" onmouseover="showTip(event, 'fs82', 383)" class="i">t</span> <span onmouseout="hideTip(event, 'fs80', 384)" onmouseover="showTip(event, 'fs80', 384)" class="i">acc</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs79', 385)" onmouseover="showTip(event, 'fs79', 385)" class="i">tree</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs59', 386)" onmouseover="showTip(event, 'fs59', 386)" class="p">Leaf</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs80', 387)" onmouseover="showTip(event, 'fs80', 387)" class="i">acc</span>
    | <span onmouseout="hideTip(event, 'fs60', 388)" onmouseover="showTip(event, 'fs60', 388)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs26', 389)" onmouseover="showTip(event, 'fs26', 389)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs62', 390)" onmouseover="showTip(event, 'fs62', 390)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs63', 391)" onmouseover="showTip(event, 'fs63', 391)" class="i">r</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs78', 392)" onmouseover="showTip(event, 'fs78', 392)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs26', 393)" onmouseover="showTip(event, 'fs26', 393)" class="i">x</span> (<span onmouseout="hideTip(event, 'fs81', 394)" onmouseover="showTip(event, 'fs81', 394)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs62', 395)" onmouseover="showTip(event, 'fs62', 395)" class="i">l</span>) (<span onmouseout="hideTip(event, 'fs81', 396)" onmouseover="showTip(event, 'fs81', 396)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs63', 397)" onmouseover="showTip(event, 'fs63', 397)" class="i">r</span>)
</code></pre></td>
</tr>
</table>
<p>Instead of a recursive <code>treeCata</code> we will create an inner <code>loop</code> function that
is used for recursion.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">treeCata</span> <span class="i">folder</span> <span class="i">tree</span> <span class="i">acc</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="i">loop</span> <span class="i">t</span> <span class="o">=</span>
        <span class="k">match</span> <span class="i">t</span> <span class="k">with</span>
        | <span class="i">Leaf</span>        <span class="k">-&gt;</span> <span class="i">acc</span>
        | <span class="i">Node</span>(<span class="i">x</span>,<span class="i">l</span>,<span class="i">r</span>) <span class="k">-&gt;</span> <span class="i">folder</span> <span class="i">x</span> (<span class="i">loop</span> <span class="i">l</span>) (<span class="i">loop</span> <span class="i">r</span>)
    <span class="i">loop</span> <span class="i">tree</span>
</code></pre></td>
</tr>
</table>
<p>As we now have an inner recursive loop we also need to explicitly
start the recursion with <code>loop tree</code>. In the next step we expand the
<code>Node</code> case and remove the nested <code>loop</code> calls and put each on its own line.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">treeCata</span> <span class="i">folder</span> <span class="i">tree</span> <span class="i">acc</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="i">loop</span> <span class="i">t</span> <span class="o">=</span>
        <span class="k">match</span> <span class="i">t</span> <span class="k">with</span>
        | <span class="i">Leaf</span>        <span class="k">-&gt;</span> <span class="i">acc</span>
        | <span class="i">Node</span>(<span class="i">x</span>,<span class="i">l</span>,<span class="i">r</span>) <span class="k">-&gt;</span>
            <span class="k">let</span> <span class="i">lacc</span> <span class="o">=</span> <span class="i">loop</span> <span class="i">l</span>
            <span class="k">let</span> <span class="i">racc</span> <span class="o">=</span> <span class="i">loop</span> <span class="i">r</span>
            <span class="i">folder</span> <span class="i">x</span> <span class="i">lacc</span> <span class="i">racc</span>
    <span class="i">loop</span> <span class="i">tree</span>
</code></pre></td>
</tr>
</table>
<p>Finally, we add <code>cont</code> (the continuation) to the <code>loop</code> function and
rename the function to <code>treeFoldBack</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs92', 457)" onmouseover="showTip(event, 'fs92', 457)" class="f">treeFoldBack</span> <span onmouseout="hideTip(event, 'fs78', 458)" onmouseover="showTip(event, 'fs78', 458)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs79', 459)" onmouseover="showTip(event, 'fs79', 459)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs80', 460)" onmouseover="showTip(event, 'fs80', 460)" class="i">acc</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">State</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs93', 461)" onmouseover="showTip(event, 'fs93', 461)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs82', 462)" onmouseover="showTip(event, 'fs82', 462)" class="i">t</span> <span onmouseout="hideTip(event, 'fs55', 463)" onmouseover="showTip(event, 'fs55', 463)" class="f">cont</span> <span class="o">=</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs82', 464)" onmouseover="showTip(event, 'fs82', 464)" class="i">t</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs59', 465)" onmouseover="showTip(event, 'fs59', 465)" class="p">Leaf</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs55', 466)" onmouseover="showTip(event, 'fs55', 466)" class="f">cont</span> <span onmouseout="hideTip(event, 'fs80', 467)" onmouseover="showTip(event, 'fs80', 467)" class="i">acc</span>
        | <span onmouseout="hideTip(event, 'fs60', 468)" onmouseover="showTip(event, 'fs60', 468)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs26', 469)" onmouseover="showTip(event, 'fs26', 469)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs62', 470)" onmouseover="showTip(event, 'fs62', 470)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs63', 471)" onmouseover="showTip(event, 'fs63', 471)" class="i">r</span>) <span class="k">-&gt;</span>
            <span onmouseout="hideTip(event, 'fs93', 472)" onmouseover="showTip(event, 'fs93', 472)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs62', 473)" onmouseover="showTip(event, 'fs62', 473)" class="i">l</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs94', 474)" onmouseover="showTip(event, 'fs94', 474)" class="i">lacc</span> <span class="k">-&gt;</span>
            <span onmouseout="hideTip(event, 'fs93', 475)" onmouseover="showTip(event, 'fs93', 475)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs63', 476)" onmouseover="showTip(event, 'fs63', 476)" class="i">r</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs56', 477)" onmouseover="showTip(event, 'fs56', 477)" class="i">racc</span> <span class="k">-&gt;</span>
                <span onmouseout="hideTip(event, 'fs55', 478)" onmouseover="showTip(event, 'fs55', 478)" class="f">cont</span> (<span onmouseout="hideTip(event, 'fs78', 479)" onmouseover="showTip(event, 'fs78', 479)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs26', 480)" onmouseover="showTip(event, 'fs26', 480)" class="i">x</span> <span onmouseout="hideTip(event, 'fs94', 481)" onmouseover="showTip(event, 'fs94', 481)" class="i">lacc</span> <span onmouseout="hideTip(event, 'fs56', 482)" onmouseover="showTip(event, 'fs56', 482)" class="i">racc</span>)
                ))
    <span onmouseout="hideTip(event, 'fs93', 483)" onmouseover="showTip(event, 'fs93', 483)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs79', 484)" onmouseover="showTip(event, 'fs79', 484)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs57', 485)" onmouseover="showTip(event, 'fs57', 485)" class="f">id</span>
</code></pre></td>
</tr>
</table>
<p>Before, we had code like:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">lacc</span> <span class="o">=</span> <span class="i">loop</span> <span class="i">l</span>
</code></pre></td>
</tr>
</table>
<p>it was recursive and it meant: Recurse on <code>loop l</code>. Somewhere in the future
(after many more recursive calls) it will return a result that we save in <code>lacc</code>.</p>
<p>Then we executed:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">racc</span> <span class="o">=</span> <span class="i">loop</span> <span class="i">r</span>
</code></pre></td>
</tr>
</table>
<p>It was recursive again and after many more recursive calls we got the result
and saved it in <code>racc</code>. But all of this is not tail-recursive. The new
<code>treeFoldBack</code> function really only has one function call.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">loop</span> <span class="i">l</span> (<span class="k">fun</span> <span class="o">..</span><span class="o">.</span>)
</code></pre></td>
</tr>
</table>
<p>The idea of continuations is like this: Please execute <code>loop l callback</code>. When
you finished calculating the result, please call the <code>callback</code> function
and pass it the result. <em>Callback</em> or <em>Continuation</em> really means the same.</p>
<p>But in this case we call <code>loop</code> that is in tail position. So we end up with a
tail-recursive function.</p>
<a name="tree-foldback-examples"></a>
<h2>FoldBack examples</h2>
<p>Instead let's focus on things we can do with <code>foldBack</code> but not with <code>fold</code>. As <code>foldBack</code>
preserves the structure, we can actually very easily convert a Tree into a string representation.</p>
<p>We just convert a <code>Leaf</code> node into the String <code>"Leaf"</code>, and a <code>Node</code> will be converted with
<code>Node(%d, %s, %s)</code> into a string. Because we get the string results instead of the recursive
values, this kind of task is pretty easy.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs77', 486)" onmouseover="showTip(event, 'fs77', 486)" class="f">treeCata</span>     (<span onmouseout="hideTip(event, 'fs95', 487)" onmouseover="showTip(event, 'fs95', 487)" class="f">sprintf</span> <span class="s">&quot;Node(</span><span class="pf">%d</span><span class="s">, </span><span class="pf">%s</span><span class="s">, </span><span class="pf">%s</span><span class="s">)&quot;</span>) <span onmouseout="hideTip(event, 'fs65', 488)" onmouseover="showTip(event, 'fs65', 488)" class="i">tree</span> <span class="s">&quot;Leaf&quot;</span>
<span onmouseout="hideTip(event, 'fs92', 489)" onmouseover="showTip(event, 'fs92', 489)" class="f">treeFoldBack</span> (<span onmouseout="hideTip(event, 'fs95', 490)" onmouseover="showTip(event, 'fs95', 490)" class="f">sprintf</span> <span class="s">&quot;Node(</span><span class="pf">%d</span><span class="s">, </span><span class="pf">%s</span><span class="s">, </span><span class="pf">%s</span><span class="s">)&quot;</span>) <span onmouseout="hideTip(event, 'fs65', 491)" onmouseover="showTip(event, 'fs65', 491)" class="i">tree</span> <span class="s">&quot;Leaf&quot;</span>
</code></pre></td>
</tr>
</table>
<p><code>treeCata</code> and <code>foldBack</code> both return the same string:
<code>"Node(4, Node(2, Node(1, Leaf, Leaf), Node(3, Leaf, Leaf)), Node(6, Node(5, Leaf, Leaf), Node(7, Leaf, Leaf)))"</code></p>
<p>I used the <code>tree</code> variable so far as a binary search tree. That means it is ordered. The left child's are
smaller, the right child's are bigger then the current element. We also can create an ordered list from
our tree. A Leaf node must be converted into an empty list. Otherwise we just need to concat the left,
current and the right node.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs96', 492)" onmouseover="showTip(event, 'fs96', 492)" class="i">ordered</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs92', 493)" onmouseover="showTip(event, 'fs92', 493)" class="f">treeFoldBack</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 494)" onmouseover="showTip(event, 'fs22', 494)" class="i">x</span> <span onmouseout="hideTip(event, 'fs97', 495)" onmouseover="showTip(event, 'fs97', 495)" class="i">l</span> <span onmouseout="hideTip(event, 'fs98', 496)" onmouseover="showTip(event, 'fs98', 496)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs97', 497)" onmouseover="showTip(event, 'fs97', 497)" class="i">l</span> <span class="o">@</span> [<span onmouseout="hideTip(event, 'fs22', 498)" onmouseover="showTip(event, 'fs22', 498)" class="i">x</span>] <span class="o">@</span> <span onmouseout="hideTip(event, 'fs98', 499)" onmouseover="showTip(event, 'fs98', 499)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs65', 500)" onmouseover="showTip(event, 'fs65', 500)" class="i">tree</span> [] <span class="c">// [1;2;3;4;5;6;7]</span>
</code></pre></td>
</tr>
</table>
<p>or any other order we like:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs99', 501)" onmouseover="showTip(event, 'fs99', 501)" class="i">reversed</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs92', 502)" onmouseover="showTip(event, 'fs92', 502)" class="f">treeFoldBack</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 503)" onmouseover="showTip(event, 'fs22', 503)" class="i">x</span> <span onmouseout="hideTip(event, 'fs97', 504)" onmouseover="showTip(event, 'fs97', 504)" class="i">l</span> <span onmouseout="hideTip(event, 'fs98', 505)" onmouseover="showTip(event, 'fs98', 505)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs98', 506)" onmouseover="showTip(event, 'fs98', 506)" class="i">r</span> <span class="o">@</span> [<span onmouseout="hideTip(event, 'fs22', 507)" onmouseover="showTip(event, 'fs22', 507)" class="i">x</span>] <span class="o">@</span> <span onmouseout="hideTip(event, 'fs97', 508)" onmouseover="showTip(event, 'fs97', 508)" class="i">l</span>) <span onmouseout="hideTip(event, 'fs65', 509)" onmouseover="showTip(event, 'fs65', 509)" class="i">tree</span> [] <span class="c">// [7;6;5;4;3;2;1]</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs100', 510)" onmouseover="showTip(event, 'fs100', 510)" class="i">preOrder</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs92', 511)" onmouseover="showTip(event, 'fs92', 511)" class="f">treeFoldBack</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 512)" onmouseover="showTip(event, 'fs22', 512)" class="i">x</span> <span onmouseout="hideTip(event, 'fs97', 513)" onmouseover="showTip(event, 'fs97', 513)" class="i">l</span> <span onmouseout="hideTip(event, 'fs98', 514)" onmouseover="showTip(event, 'fs98', 514)" class="i">r</span> <span class="k">-&gt;</span> [<span onmouseout="hideTip(event, 'fs22', 515)" onmouseover="showTip(event, 'fs22', 515)" class="i">x</span>] <span class="o">@</span> <span onmouseout="hideTip(event, 'fs97', 516)" onmouseover="showTip(event, 'fs97', 516)" class="i">l</span> <span class="o">@</span> <span onmouseout="hideTip(event, 'fs98', 517)" onmouseover="showTip(event, 'fs98', 517)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs65', 518)" onmouseover="showTip(event, 'fs65', 518)" class="i">tree</span> [] <span class="c">// [4;2;1;3;6;5;7]</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs101', 519)" onmouseover="showTip(event, 'fs101', 519)" class="i">postOrder</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs92', 520)" onmouseover="showTip(event, 'fs92', 520)" class="f">treeFoldBack</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 521)" onmouseover="showTip(event, 'fs22', 521)" class="i">x</span> <span onmouseout="hideTip(event, 'fs97', 522)" onmouseover="showTip(event, 'fs97', 522)" class="i">l</span> <span onmouseout="hideTip(event, 'fs98', 523)" onmouseover="showTip(event, 'fs98', 523)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs97', 524)" onmouseover="showTip(event, 'fs97', 524)" class="i">l</span> <span class="o">@</span> <span onmouseout="hideTip(event, 'fs98', 525)" onmouseover="showTip(event, 'fs98', 525)" class="i">r</span> <span class="o">@</span> [<span onmouseout="hideTip(event, 'fs22', 526)" onmouseover="showTip(event, 'fs22', 526)" class="i">x</span>]) <span onmouseout="hideTip(event, 'fs65', 527)" onmouseover="showTip(event, 'fs65', 527)" class="i">tree</span> [] <span class="c">// [1;3;2;5;7;6;4]</span>
</code></pre></td>
</tr>
</table>
<p>Let's turn the Tree into Lisp code. In Lisp a tree is just represented as a list with
tree elements. The first element is the current node, the second and third element represent
the left and right node, and are just lists themselves. The Leaf node is represented as the
empty list.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="s">&quot;(quote &quot;</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs92', 528)" onmouseover="showTip(event, 'fs92', 528)" class="f">treeFoldBack</span> (<span onmouseout="hideTip(event, 'fs95', 529)" onmouseover="showTip(event, 'fs95', 529)" class="f">sprintf</span> <span class="s">&quot;(</span><span class="pf">%d</span><span class="s"> </span><span class="pf">%s</span><span class="s"> </span><span class="pf">%s</span><span class="s">)&quot;</span>) <span onmouseout="hideTip(event, 'fs65', 530)" onmouseover="showTip(event, 'fs65', 530)" class="i">tree</span> <span class="s">&quot;empty&quot;</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
<span class="c">// &quot;(quote (4 (2 (1 empty empty) (3 empty empty)) (6 (5 empty empty) (7 empty empty))))&quot;</span>
</code></pre></td>
</tr>
</table>
<p>Let's test it in Racket.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="racket">(define tree (quote (4 (2 (1 empty empty) (3 empty empty)) (6 (5 empty empty) (7 empty empty)))))
(define (left tree)  (car (cdr tree)))
(define (right tree) (car (cdr (cdr tree))))
(define (datum tree) (car tree))
</code></pre></td></tr></table>
<p>and in the REPL:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip"><code lang="console">&gt; (datum (left (left tree)))
1
&gt; (datum (left (right tree)))
5
</code></pre></td></tr></table>
<p>Nice, this is correct. For the last example let's look again at our example tree:</p>
<div style="width:50%;margin: 0 auto">
<img src="/images/2016/catamorphisms/tree.svg" alt="Binary Tree" />
</div>
<p>Let's say we want to create a path to a specific element. For example when we search for <code>5</code>, we want
the steps to find <code>5</code>. When we start at <code>4</code> we first must go right, and then Left. So we want "Right Left"
as a result. When we search for <code>1</code> we get "Left Left" and so on.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs102', 531)" onmouseover="showTip(event, 'fs102', 531)" class="f">path</span> <span onmouseout="hideTip(event, 'fs103', 532)" onmouseover="showTip(event, 'fs103', 532)" class="i">search</span> <span onmouseout="hideTip(event, 'fs104', 533)" onmouseover="showTip(event, 'fs104', 533)" class="i">tree</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs105', 534)" onmouseover="showTip(event, 'fs105', 534)" class="i">leaf</span> <span class="o">=</span> (<span class="k">false</span>, [])
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs106', 535)" onmouseover="showTip(event, 'fs106', 535)" class="f">node</span> <span onmouseout="hideTip(event, 'fs107', 536)" onmouseover="showTip(event, 'fs107', 536)" class="i">x</span> (<span onmouseout="hideTip(event, 'fs108', 537)" onmouseover="showTip(event, 'fs108', 537)" class="i">lb</span>,<span onmouseout="hideTip(event, 'fs109', 538)" onmouseover="showTip(event, 'fs109', 538)" class="i">lp</span>) (<span onmouseout="hideTip(event, 'fs110', 539)" onmouseover="showTip(event, 'fs110', 539)" class="i">rb</span>,<span onmouseout="hideTip(event, 'fs111', 540)" onmouseover="showTip(event, 'fs111', 540)" class="i">rp</span>) <span class="o">=</span>
        <span class="k">if</span> <span onmouseout="hideTip(event, 'fs107', 541)" onmouseover="showTip(event, 'fs107', 541)" class="i">x</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs103', 542)" onmouseover="showTip(event, 'fs103', 542)" class="i">search</span> <span class="k">then</span>
            (<span class="k">true</span>, [])
        <span class="k">elif</span> <span onmouseout="hideTip(event, 'fs108', 543)" onmouseover="showTip(event, 'fs108', 543)" class="i">lb</span> <span class="o">=</span> <span class="k">true</span> <span class="k">then</span>
            (<span class="k">true</span>, <span class="s">&quot;Left&quot;</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs109', 544)" onmouseover="showTip(event, 'fs109', 544)" class="i">lp</span>)
        <span class="k">elif</span> <span onmouseout="hideTip(event, 'fs110', 545)" onmouseover="showTip(event, 'fs110', 545)" class="i">rb</span> <span class="o">=</span> <span class="k">true</span> <span class="k">then</span>
            (<span class="k">true</span>, <span class="s">&quot;Right&quot;</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs111', 546)" onmouseover="showTip(event, 'fs111', 546)" class="i">rp</span>)
        <span class="k">else</span>
            (<span class="k">false</span>, [])
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs112', 547)" onmouseover="showTip(event, 'fs112', 547)" class="i">path</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs92', 548)" onmouseover="showTip(event, 'fs92', 548)" class="f">treeFoldBack</span> <span onmouseout="hideTip(event, 'fs106', 549)" onmouseover="showTip(event, 'fs106', 549)" class="f">node</span> <span onmouseout="hideTip(event, 'fs104', 550)" onmouseover="showTip(event, 'fs104', 550)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs105', 551)" onmouseover="showTip(event, 'fs105', 551)" class="i">leaf</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs112', 552)" onmouseover="showTip(event, 'fs112', 552)" class="i">path</span> <span class="k">with</span>
    | (<span class="k">true</span>, []) <span class="k">-&gt;</span> <span class="s">&quot;First element&quot;</span>
    | (<span class="k">true</span>, <span onmouseout="hideTip(event, 'fs113', 553)" onmouseover="showTip(event, 'fs113', 553)" class="i">p</span>)  <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs23', 554)" onmouseover="showTip(event, 'fs23', 554)" class="t">String</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs114', 555)" onmouseover="showTip(event, 'fs114', 555)" class="f">concat</span> <span class="s">&quot; &quot;</span> <span onmouseout="hideTip(event, 'fs113', 556)" onmouseover="showTip(event, 'fs113', 556)" class="i">p</span>
    | (<span class="k">false</span>, _) <span class="k">-&gt;</span> <span class="s">&quot;Not in Tree&quot;</span>

<span onmouseout="hideTip(event, 'fs102', 557)" onmouseover="showTip(event, 'fs102', 557)" class="f">path</span> <span class="n">1</span> <span onmouseout="hideTip(event, 'fs65', 558)" onmouseover="showTip(event, 'fs65', 558)" class="i">tree</span> <span class="c">// &quot;Left Left&quot;</span>
<span onmouseout="hideTip(event, 'fs102', 559)" onmouseover="showTip(event, 'fs102', 559)" class="f">path</span> <span class="n">2</span> <span onmouseout="hideTip(event, 'fs65', 560)" onmouseover="showTip(event, 'fs65', 560)" class="i">tree</span> <span class="c">// &quot;Left&quot;</span>
<span onmouseout="hideTip(event, 'fs102', 561)" onmouseover="showTip(event, 'fs102', 561)" class="f">path</span> <span class="n">3</span> <span onmouseout="hideTip(event, 'fs65', 562)" onmouseover="showTip(event, 'fs65', 562)" class="i">tree</span> <span class="c">// &quot;Left Right&quot;</span>
<span onmouseout="hideTip(event, 'fs102', 563)" onmouseover="showTip(event, 'fs102', 563)" class="f">path</span> <span class="n">4</span> <span onmouseout="hideTip(event, 'fs65', 564)" onmouseover="showTip(event, 'fs65', 564)" class="i">tree</span> <span class="c">// &quot;First Element&quot;</span>
<span onmouseout="hideTip(event, 'fs102', 565)" onmouseover="showTip(event, 'fs102', 565)" class="f">path</span> <span class="n">5</span> <span onmouseout="hideTip(event, 'fs65', 566)" onmouseover="showTip(event, 'fs65', 566)" class="i">tree</span> <span class="c">// &quot;Right Left&quot;</span>
<span onmouseout="hideTip(event, 'fs102', 567)" onmouseover="showTip(event, 'fs102', 567)" class="f">path</span> <span class="n">9</span> <span onmouseout="hideTip(event, 'fs65', 568)" onmouseover="showTip(event, 'fs65', 568)" class="i">tree</span> <span class="c">// &quot;Not in Tree&quot;</span>
</code></pre></td>
</tr>
</table>
<p>In the solution I just transform every node into a tuple that contains two informations. A boolean that
contains the information if the child contains the searched element. And when it is <code>true</code> the
node above prepend either <code>"Left"</code> or <code>"Right"</code> to the list. As an example, when we search for
<code>5</code> we get the following transformations:</p>
<p><img src="/images/2016/catamorphisms/tree_path_5.svg" alt="Tree with path to 5" /></p>
<a name="tree-fold"></a>
<h2>Fold for Tree</h2>
<p>At last we want to look at <code>fold</code>. As we learned so far, we don't need to implement a particular
tree traversal order. For <code>fold</code> it is only important that we visit every node and we treat an
accumulator through the calculation. For implementing <code>fold</code> we should just pick the easiest
or fastest way we can come up with.</p>
<p>Up so far, including the other blog posts, I showed two ways how to achieve tail-recursion. Either
way through an accumulator or through a continuation function. But both ideas don't work
with our tree. The problem is that we don't just have a simple calculation that we can forward
as an accumulator, we always must traverse two child's for every node.</p>
<p>The solution to fix that is that we manage the stack ourselves. This is the typical solution
how languages without proper tail-call-optimization handles recursion. But in the F#
case we don't need to switch completely to looping. We just make the stack part as an additional
value on the recursive inner loop function. We also could say, we use two accumulators. One
for the value we computed so far, and another that keeps track of task we still need to do later.</p>
<p>So here is the idea. At first we identify what we actually need to do in the <code>Node</code> case.
And they are three things we need to do:</p>
<ol>
<li>Process the current element</li>
<li>Recurs on the left child</li>
<li>Recurs on the right child</li>
</ol>
<p>We should pick a order of the operation so that only one task remains open. And this task is pushed
onto a stack that can be later processed. One way to achieve that is.</p>
<ol>
<li>We process the current element</li>
<li>We put the right child onto the stack</li>
<li>We loop on the left child</li>
</ol>
<p>Let's give it a first try:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs115', 569)" onmouseover="showTip(event, 'fs115', 569)" class="f">treeFold&#39;</span> <span onmouseout="hideTip(event, 'fs116', 570)" onmouseover="showTip(event, 'fs116', 570)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs117', 571)" onmouseover="showTip(event, 'fs117', 571)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs69', 572)" onmouseover="showTip(event, 'fs69', 572)" class="i">tree</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs118', 573)" onmouseover="showTip(event, 'fs118', 573)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 574)" onmouseover="showTip(event, 'fs117', 574)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs119', 575)" onmouseover="showTip(event, 'fs119', 575)" class="i">stack</span> <span onmouseout="hideTip(event, 'fs69', 576)" onmouseover="showTip(event, 'fs69', 576)" class="i">tree</span> <span class="o">=</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs69', 577)" onmouseover="showTip(event, 'fs69', 577)" class="i">tree</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs59', 578)" onmouseover="showTip(event, 'fs59', 578)" class="p">Leaf</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs117', 579)" onmouseover="showTip(event, 'fs117', 579)" class="i">acc</span>
        | <span onmouseout="hideTip(event, 'fs60', 580)" onmouseover="showTip(event, 'fs60', 580)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs70', 581)" onmouseover="showTip(event, 'fs70', 581)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs71', 582)" onmouseover="showTip(event, 'fs71', 582)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs72', 583)" onmouseover="showTip(event, 'fs72', 583)" class="i">r</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs118', 584)" onmouseover="showTip(event, 'fs118', 584)" class="f">loop</span> (<span onmouseout="hideTip(event, 'fs116', 585)" onmouseover="showTip(event, 'fs116', 585)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs117', 586)" onmouseover="showTip(event, 'fs117', 586)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs70', 587)" onmouseover="showTip(event, 'fs70', 587)" class="i">x</span>) (<span onmouseout="hideTip(event, 'fs72', 588)" onmouseover="showTip(event, 'fs72', 588)" class="i">r</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs119', 589)" onmouseover="showTip(event, 'fs119', 589)" class="i">stack</span>) <span onmouseout="hideTip(event, 'fs71', 590)" onmouseover="showTip(event, 'fs71', 590)" class="i">l</span>
    <span onmouseout="hideTip(event, 'fs118', 591)" onmouseover="showTip(event, 'fs118', 591)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 592)" onmouseover="showTip(event, 'fs117', 592)" class="i">acc</span> [] <span onmouseout="hideTip(event, 'fs69', 593)" onmouseover="showTip(event, 'fs69', 593)" class="i">tree</span>
</code></pre></td>
</tr>
</table>
<p>Let's test it:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs115', 594)" onmouseover="showTip(event, 'fs115', 594)" class="f">treeFold&#39;</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs120', 595)" onmouseover="showTip(event, 'fs120', 595)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs22', 596)" onmouseover="showTip(event, 'fs22', 596)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs121', 597)" onmouseover="showTip(event, 'fs121', 597)" class="f">printf</span> <span class="s">&quot;</span><span class="pf">%d</span><span class="s"> &quot;</span> <span onmouseout="hideTip(event, 'fs22', 598)" onmouseover="showTip(event, 'fs22', 598)" class="i">x</span>) () <span onmouseout="hideTip(event, 'fs65', 599)" onmouseover="showTip(event, 'fs65', 599)" class="i">tree</span> <span class="c">// 4 2 1</span>
</code></pre></td>
</tr>
</table>
<p>Okay, that's not quite right, but I wrote it in this way so we can discuss what happens. This makes it
easier to understand the full solution. At first, if you find the short <code>Node</code> case hard to understand,
you can expand it. The line:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">loop</span> (<span class="i">folder</span> <span class="i">acc</span> <span class="i">x</span>) (<span class="i">r</span> <span class="o">::</span> <span class="i">stack</span>) <span class="i">l</span>
</code></pre></td>
</tr>
</table>
<p>is the same as:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">newAcc</span>   <span class="o">=</span> <span class="i">folder</span> <span class="i">acc</span> <span class="i">x</span>
<span class="k">let</span> <span class="i">newStack</span> <span class="o">=</span> <span class="i">r</span> <span class="o">::</span> <span class="i">stack</span>
<span class="i">loop</span> <span class="i">newAcc</span> <span class="i">newStack</span> <span class="i">l</span>
</code></pre></td>
</tr>
</table>
<p>But all in one, here are the things that are happening:</p>
<ol>
<li>We enter the tree.</li>
<li>We process element <code>4</code>, by printing it <code>(folder acc x)</code></li>
<li>The right child of <code>4</code> is added to the stack <code>r :: stack</code></li>
<li>We loop on the left-child</li>
<li>We process element <code>2</code>, by printing it</li>
<li>The right child of <code>2</code> is added to the stack</li>
<li>We loop on the left-child</li>
<li>We process element <code>1</code>, by printing it</li>
<li>The right child of <code>1</code> is added to the stack (a Leaf)</li>
<li>We loop on the left-child</li>
<li>We hit a Leaf, and we return <code>acc</code>.</li>
</ol>
<p>So what are we missing? Sure, we forgot to process the <em>right-child's</em>. We put them all
onto the stack, but we never look at them. So what we need to do is to extend the <code>Leaf</code> case.
Instead of immediately returning <code>acc</code>, we first need to check if there are pending
trees in the <code>stack</code>. If yes, we need to loop on those. Only if the <code>stack</code> is empty
we can return <code>acc</code>. So our final <code>treeFold</code> looks like this:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs122', 600)" onmouseover="showTip(event, 'fs122', 600)" class="f">treeFold</span> <span onmouseout="hideTip(event, 'fs116', 601)" onmouseover="showTip(event, 'fs116', 601)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs117', 602)" onmouseover="showTip(event, 'fs117', 602)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs69', 603)" onmouseover="showTip(event, 'fs69', 603)" class="i">tree</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs118', 604)" onmouseover="showTip(event, 'fs118', 604)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 605)" onmouseover="showTip(event, 'fs117', 605)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs119', 606)" onmouseover="showTip(event, 'fs119', 606)" class="i">stack</span> <span onmouseout="hideTip(event, 'fs69', 607)" onmouseover="showTip(event, 'fs69', 607)" class="i">tree</span> <span class="o">=</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs69', 608)" onmouseover="showTip(event, 'fs69', 608)" class="i">tree</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs59', 609)" onmouseover="showTip(event, 'fs59', 609)" class="p">Leaf</span> <span class="k">-&gt;</span>
            <span class="k">match</span> <span onmouseout="hideTip(event, 'fs119', 610)" onmouseover="showTip(event, 'fs119', 610)" class="i">stack</span> <span class="k">with</span>
            | []          <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs117', 611)" onmouseover="showTip(event, 'fs117', 611)" class="i">acc</span>
            | <span onmouseout="hideTip(event, 'fs69', 612)" onmouseover="showTip(event, 'fs69', 612)" class="i">tree</span><span class="o">::</span><span onmouseout="hideTip(event, 'fs119', 613)" onmouseover="showTip(event, 'fs119', 613)" class="i">stack</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs118', 614)" onmouseover="showTip(event, 'fs118', 614)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 615)" onmouseover="showTip(event, 'fs117', 615)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs119', 616)" onmouseover="showTip(event, 'fs119', 616)" class="i">stack</span> <span onmouseout="hideTip(event, 'fs69', 617)" onmouseover="showTip(event, 'fs69', 617)" class="i">tree</span>
        | <span onmouseout="hideTip(event, 'fs60', 618)" onmouseover="showTip(event, 'fs60', 618)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs70', 619)" onmouseover="showTip(event, 'fs70', 619)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs71', 620)" onmouseover="showTip(event, 'fs71', 620)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs72', 621)" onmouseover="showTip(event, 'fs72', 621)" class="i">r</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs118', 622)" onmouseover="showTip(event, 'fs118', 622)" class="f">loop</span> (<span onmouseout="hideTip(event, 'fs116', 623)" onmouseover="showTip(event, 'fs116', 623)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs117', 624)" onmouseover="showTip(event, 'fs117', 624)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs70', 625)" onmouseover="showTip(event, 'fs70', 625)" class="i">x</span>) (<span onmouseout="hideTip(event, 'fs72', 626)" onmouseover="showTip(event, 'fs72', 626)" class="i">r</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs119', 627)" onmouseover="showTip(event, 'fs119', 627)" class="i">stack</span>) <span onmouseout="hideTip(event, 'fs71', 628)" onmouseover="showTip(event, 'fs71', 628)" class="i">l</span>
    <span onmouseout="hideTip(event, 'fs118', 629)" onmouseover="showTip(event, 'fs118', 629)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 630)" onmouseover="showTip(event, 'fs117', 630)" class="i">acc</span> [] <span onmouseout="hideTip(event, 'fs69', 631)" onmouseover="showTip(event, 'fs69', 631)" class="i">tree</span>
</code></pre></td>
</tr>
</table>
<p>Now we get all numbers printed.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs122', 632)" onmouseover="showTip(event, 'fs122', 632)" class="f">treeFold</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs120', 633)" onmouseover="showTip(event, 'fs120', 633)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs22', 634)" onmouseover="showTip(event, 'fs22', 634)" class="i">x</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs121', 635)" onmouseover="showTip(event, 'fs121', 635)" class="f">printf</span> <span class="s">&quot;</span><span class="pf">%d</span><span class="s"> &quot;</span> <span onmouseout="hideTip(event, 'fs22', 636)" onmouseover="showTip(event, 'fs22', 636)" class="i">x</span>) () <span onmouseout="hideTip(event, 'fs65', 637)" onmouseover="showTip(event, 'fs65', 637)" class="i">tree</span> <span class="c">// 4 2 1 3 6 5 7</span>
</code></pre></td>
</tr>
</table>
<p>And if you noticed, this kind of tree-traversal is a pre-order tree traversal. But it is only pre-order
traversal by accident. I just thought of an easy way to traverse so we need to put as few things as possible
onto the <code>stack</code> variable. Someone should not expect a specific tree traversal order for <code>fold</code>.</p>
<a name="benchmarking"></a>
<h2>Some Benchmarking</h2>
<p>I think some simple benchmarks are quite good. At first, we always talk about tail-recursion and
I provided ways to achieve it, but never looked at performance. And there are two things to say here.</p>
<p>First, tail-recursion is not about performance. Yes, sometimes it also improves performance, but the
main point of tail-recursion is that we don't end up with stack overflows. We first care for
correctness, only then comes speed. If you think otherwise, then answer me the following question:
What exactly do we get out of a function that is theoretically fast, but practically we cannot
execute it because it crashes with a stack overflow? So the main point of tail-recursion is
Correctness, that it is <em>sometimes</em> faster is more an additional benefit.</p>
<p>Second, tail-recursion with a continuation approach how i used it with <code>foldBack</code> is usually
<strong>slower</strong> than pure recursion!</p>
<p>All of those are important. At first, you shouldn't implement tail-recursion just because someone
told you it is better or faster. It not only can be slower, it also can be harder to understand
and to maintain. So you really should ask yourself if you really need tail-recursion. And
for a binary tree this question is already legit. If you create a binary tree that always balance
itself, then you will less likely run into any kind of problems with a non tail-recursive <code>cata</code>
function.</p>
<p>With a stack depth of 1 you can handle two values (empty and one value), with a stack depth
of 2 you can handle 4 values. 3 is already 8 values. So the amount of values doubles by just
increasing the depth by one. With a stack depth of 32, what is just peanuts, you already
can handle 4.294.967.296 values. Before you run into problems with the stack depth you run
into completely other problems! Even if you just save 32-bit integers just the integers alone
already need 16 GiB of memory, and that does not include the <code>Node(x,l,r)</code> objects that also
consumes memory. So you should ask yourself if you really need a <code>fold</code> or <code>foldback</code> function
that are harder to develop and probably even can be slower!</p>
<p>But let's see some benchmarks. First I create some helper functions for the creation of some trees.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs123', 638)" onmouseover="showTip(event, 'fs123', 638)" class="f">createTree</span> <span onmouseout="hideTip(event, 'fs124', 639)" onmouseover="showTip(event, 'fs124', 639)" class="f">builder</span> <span onmouseout="hideTip(event, 'fs125', 640)" onmouseover="showTip(event, 'fs125', 640)" class="i">init</span> <span onmouseout="hideTip(event, 'fs126', 641)" onmouseover="showTip(event, 'fs126', 641)" class="i">depth</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs127', 642)" onmouseover="showTip(event, 'fs127', 642)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs128', 643)" onmouseover="showTip(event, 'fs128', 643)" class="i">count</span> <span onmouseout="hideTip(event, 'fs129', 644)" onmouseover="showTip(event, 'fs129', 644)" class="i">tree</span> <span class="o">=</span>
        <span class="k">if</span>   <span onmouseout="hideTip(event, 'fs128', 645)" onmouseover="showTip(event, 'fs128', 645)" class="i">count</span> <span class="o">&lt;</span> <span onmouseout="hideTip(event, 'fs126', 646)" onmouseover="showTip(event, 'fs126', 646)" class="i">depth</span>
        <span class="k">then</span> <span onmouseout="hideTip(event, 'fs127', 647)" onmouseover="showTip(event, 'fs127', 647)" class="f">loop</span> (<span onmouseout="hideTip(event, 'fs128', 648)" onmouseover="showTip(event, 'fs128', 648)" class="i">count</span><span class="o">+</span><span class="n">1</span>) (<span onmouseout="hideTip(event, 'fs124', 649)" onmouseover="showTip(event, 'fs124', 649)" class="f">builder</span> <span onmouseout="hideTip(event, 'fs129', 650)" onmouseover="showTip(event, 'fs129', 650)" class="i">tree</span>)
        <span class="k">else</span> <span onmouseout="hideTip(event, 'fs129', 651)" onmouseover="showTip(event, 'fs129', 651)" class="i">tree</span>
    <span onmouseout="hideTip(event, 'fs127', 652)" onmouseover="showTip(event, 'fs127', 652)" class="f">loop</span> <span class="n">1</span> <span onmouseout="hideTip(event, 'fs125', 653)" onmouseover="showTip(event, 'fs125', 653)" class="i">init</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs130', 654)" onmouseover="showTip(event, 'fs130', 654)" class="f">createLeftTree</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs123', 655)" onmouseover="showTip(event, 'fs123', 655)" class="f">createTree</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs87', 656)" onmouseover="showTip(event, 'fs87', 656)" class="i">tree</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs61', 657)" onmouseover="showTip(event, 'fs61', 657)" class="f">node</span> <span class="n">1</span> <span onmouseout="hideTip(event, 'fs87', 658)" onmouseover="showTip(event, 'fs87', 658)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs59', 659)" onmouseover="showTip(event, 'fs59', 659)" class="p">Leaf</span>) (<span onmouseout="hideTip(event, 'fs64', 660)" onmouseover="showTip(event, 'fs64', 660)" class="f">endNode</span> <span class="n">1</span>)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs131', 661)" onmouseover="showTip(event, 'fs131', 661)" class="f">createRightTree</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs123', 662)" onmouseover="showTip(event, 'fs123', 662)" class="f">createTree</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs87', 663)" onmouseover="showTip(event, 'fs87', 663)" class="i">tree</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs61', 664)" onmouseover="showTip(event, 'fs61', 664)" class="f">node</span> <span class="n">1</span> <span onmouseout="hideTip(event, 'fs59', 665)" onmouseover="showTip(event, 'fs59', 665)" class="p">Leaf</span> <span onmouseout="hideTip(event, 'fs87', 666)" onmouseover="showTip(event, 'fs87', 666)" class="i">tree</span>) (<span onmouseout="hideTip(event, 'fs64', 667)" onmouseover="showTip(event, 'fs64', 667)" class="f">endNode</span> <span class="n">1</span>)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs132', 668)" onmouseover="showTip(event, 'fs132', 668)" class="f">createBalanced</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs123', 669)" onmouseover="showTip(event, 'fs123', 669)" class="f">createTree</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs87', 670)" onmouseover="showTip(event, 'fs87', 670)" class="i">tree</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs61', 671)" onmouseover="showTip(event, 'fs61', 671)" class="f">node</span> <span class="n">1</span> <span onmouseout="hideTip(event, 'fs87', 672)" onmouseover="showTip(event, 'fs87', 672)" class="i">tree</span> <span onmouseout="hideTip(event, 'fs87', 673)" onmouseover="showTip(event, 'fs87', 673)" class="i">tree</span>) (<span onmouseout="hideTip(event, 'fs64', 674)" onmouseover="showTip(event, 'fs64', 674)" class="f">endNode</span> <span class="n">1</span>)
</code></pre></td>
</tr>
</table>
<p>So let's create some small trees with 10K nodes.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs133', 675)" onmouseover="showTip(event, 'fs133', 675)" class="i">smallL</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs130', 676)" onmouseover="showTip(event, 'fs130', 676)" class="f">createLeftTree</span>  <span class="n">10000</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs134', 677)" onmouseover="showTip(event, 'fs134', 677)" class="i">smallR</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs131', 678)" onmouseover="showTip(event, 'fs131', 678)" class="f">createRightTree</span> <span class="n">10000</span>
</code></pre></td>
</tr>
</table>
<p>Those trees are not balanced, but they can still be handled by <code>cata</code> on my machine. But just benchmarking
one call is still too fast, so I create a <code>bench</code> function that calls some code a specific amount of time.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs135', 679)" onmouseover="showTip(event, 'fs135', 679)" class="f">bench</span> <span onmouseout="hideTip(event, 'fs136', 680)" onmouseover="showTip(event, 'fs136', 680)" class="i">times</span> <span onmouseout="hideTip(event, 'fs137', 681)" onmouseover="showTip(event, 'fs137', 681)" class="f">f</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs138', 682)" onmouseover="showTip(event, 'fs138', 682)" class="i">sw</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs139', 683)" onmouseover="showTip(event, 'fs139', 683)" class="t">Stopwatch</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs140', 684)" onmouseover="showTip(event, 'fs140', 684)" class="f">StartNew</span>()
    <span class="k">for</span> <span onmouseout="hideTip(event, 'fs141', 685)" onmouseover="showTip(event, 'fs141', 685)" class="i">i</span> <span class="k">in</span> <span class="n">1</span> <span class="o">..</span> <span onmouseout="hideTip(event, 'fs136', 686)" onmouseover="showTip(event, 'fs136', 686)" class="i">times</span> <span class="k">do</span>
        <span onmouseout="hideTip(event, 'fs137', 687)" onmouseover="showTip(event, 'fs137', 687)" class="f">f</span> () <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs142', 688)" onmouseover="showTip(event, 'fs142', 688)" class="f">ignore</span>
    <span onmouseout="hideTip(event, 'fs138', 689)" onmouseover="showTip(event, 'fs138', 689)" class="i">sw</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs143', 690)" onmouseover="showTip(event, 'fs143', 690)" class="f">Stop</span>()
    <span onmouseout="hideTip(event, 'fs144', 691)" onmouseover="showTip(event, 'fs144', 691)" class="f">printfn</span> <span class="s">&quot;Timing: </span><span class="pf">%O</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs138', 692)" onmouseover="showTip(event, 'fs138', 692)" class="i">sw</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs145', 693)" onmouseover="showTip(event, 'fs145', 693)" class="i">Elapsed</span>
</code></pre></td>
</tr>
</table>
<p>So, when we sum up every 10.000 nodes with <code>treeCata</code> and do that 10.000 times, which timings do we
get for <code>treeCata</code> and <code>foldBack</code>? I run every <code>bench</code> line twice.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs135', 694)" onmouseover="showTip(event, 'fs135', 694)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs77', 695)" onmouseover="showTip(event, 'fs77', 695)" class="f">treeCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 696)" onmouseover="showTip(event, 'fs22', 696)" class="i">x</span> <span onmouseout="hideTip(event, 'fs84', 697)" onmouseover="showTip(event, 'fs84', 697)" class="i">l</span> <span onmouseout="hideTip(event, 'fs85', 698)" onmouseover="showTip(event, 'fs85', 698)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 699)" onmouseover="showTip(event, 'fs22', 699)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs84', 700)" onmouseover="showTip(event, 'fs84', 700)" class="i">l</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs85', 701)" onmouseover="showTip(event, 'fs85', 701)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs133', 702)" onmouseover="showTip(event, 'fs133', 702)" class="i">smallL</span> <span class="n">0</span>)
<span class="c">// Real: 00:00:04.290, CPU: 00:00:04.296, GC gen0: 0, gen1: 0, gen2: 0</span>
<span class="c">// Real: 00:00:04.292, CPU: 00:00:04.265, GC gen0: 0, gen1: 0, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs135', 703)" onmouseover="showTip(event, 'fs135', 703)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs77', 704)" onmouseover="showTip(event, 'fs77', 704)" class="f">treeCata</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 705)" onmouseover="showTip(event, 'fs22', 705)" class="i">x</span> <span onmouseout="hideTip(event, 'fs84', 706)" onmouseover="showTip(event, 'fs84', 706)" class="i">l</span> <span onmouseout="hideTip(event, 'fs85', 707)" onmouseover="showTip(event, 'fs85', 707)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 708)" onmouseover="showTip(event, 'fs22', 708)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs84', 709)" onmouseover="showTip(event, 'fs84', 709)" class="i">l</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs85', 710)" onmouseover="showTip(event, 'fs85', 710)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs134', 711)" onmouseover="showTip(event, 'fs134', 711)" class="i">smallR</span> <span class="n">0</span>)
<span class="c">// Real: 00:00:04.145, CPU: 00:00:04.140, GC gen0: 0, gen1: 0, gen2: 0</span>
<span class="c">// Real: 00:00:04.144, CPU: 00:00:04.140, GC gen0: 0, gen1: 0, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs135', 712)" onmouseover="showTip(event, 'fs135', 712)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs92', 713)" onmouseover="showTip(event, 'fs92', 713)" class="f">treeFoldBack</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 714)" onmouseover="showTip(event, 'fs22', 714)" class="i">x</span> <span onmouseout="hideTip(event, 'fs84', 715)" onmouseover="showTip(event, 'fs84', 715)" class="i">l</span> <span onmouseout="hideTip(event, 'fs85', 716)" onmouseover="showTip(event, 'fs85', 716)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 717)" onmouseover="showTip(event, 'fs22', 717)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs84', 718)" onmouseover="showTip(event, 'fs84', 718)" class="i">l</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs85', 719)" onmouseover="showTip(event, 'fs85', 719)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs133', 720)" onmouseover="showTip(event, 'fs133', 720)" class="i">smallL</span> <span class="n">0</span>)
<span class="c">// Real: 00:00:07.518, CPU: 00:00:07.546, GC gen0: 1617, gen1: 1616, gen2: 1</span>
<span class="c">// Real: 00:00:07.448, CPU: 00:00:07.437, GC gen0: 1621, gen1: 1621, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs135', 721)" onmouseover="showTip(event, 'fs135', 721)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs92', 722)" onmouseover="showTip(event, 'fs92', 722)" class="f">treeFoldBack</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs22', 723)" onmouseover="showTip(event, 'fs22', 723)" class="i">x</span> <span onmouseout="hideTip(event, 'fs84', 724)" onmouseover="showTip(event, 'fs84', 724)" class="i">l</span> <span onmouseout="hideTip(event, 'fs85', 725)" onmouseover="showTip(event, 'fs85', 725)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs22', 726)" onmouseover="showTip(event, 'fs22', 726)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs84', 727)" onmouseover="showTip(event, 'fs84', 727)" class="i">l</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs85', 728)" onmouseover="showTip(event, 'fs85', 728)" class="i">r</span>) <span onmouseout="hideTip(event, 'fs134', 729)" onmouseover="showTip(event, 'fs134', 729)" class="i">smallR</span> <span class="n">0</span>)
<span class="c">// Real: 00:00:08.076, CPU: 00:00:08.078, GC gen0: 1628, gen1: 1628, gen2: 0</span>
<span class="c">// Real: 00:00:08.146, CPU: 00:00:08.140, GC gen0: 1625, gen1: 1625, gen2: 0</span>
</code></pre></td>
</tr>
</table>
<p>So overall, the <code>foldBack</code> result are disastrous. At first, creating a lot of continuation
functions creates a lot of garbage, all those closure functions needs to be managed on
the heap. As a result the garbage collector runs quite often. 1600 gen0 and 1600 gen1 clean-ups!
Overall <code>foldBack</code> is tail-recursive, but takes the double of time to finish compared
to the <code>cata</code> functions. On top, the <code>cata</code> functions trigger not a single garbage collection
clean-up, that is probably also the reason why they are faster.</p>
<p>But we also should consider <code>treeFold</code>. Actually just summing up the nodes is also a task
that can be done by <code>treeFold</code>, so how fast is <code>treeFold</code>?</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs135', 730)" onmouseover="showTip(event, 'fs135', 730)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs122', 731)" onmouseover="showTip(event, 'fs122', 731)" class="f">treeFold</span> (<span class="o">+</span>) <span class="n">0</span> <span onmouseout="hideTip(event, 'fs133', 732)" onmouseover="showTip(event, 'fs133', 732)" class="i">smallL</span>)
<span class="c">// Real: 00:00:02.882, CPU: 00:00:02.890, GC gen0: 508, gen1: 508, gen2: 0</span>
<span class="c">// Real: 00:00:02.864, CPU: 00:00:02.859, GC gen0: 508, gen1: 508, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs135', 733)" onmouseover="showTip(event, 'fs135', 733)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs122', 734)" onmouseover="showTip(event, 'fs122', 734)" class="f">treeFold</span> (<span class="o">+</span>) <span class="n">0</span> <span onmouseout="hideTip(event, 'fs134', 735)" onmouseover="showTip(event, 'fs134', 735)" class="i">smallR</span>)
<span class="c">// Real: 00:00:02.830, CPU: 00:00:02.812, GC gen0: 508, gen1: 508, gen2: 0</span>
<span class="c">// Real: 00:00:02.824, CPU: 00:00:02.828, GC gen0: 509, gen1: 509, gen2: 0</span>
</code></pre></td>
</tr>
</table>
<p>Those results are quite interesting. They are faster as <code>treeCata</code> and <code>treeFoldback</code>. I
expected that it is faster as <code>foldBack</code>, because just handling a stack of trees should
be way more efficient as handling a lot of closure functions. But even the fact that
they still trigger quite a lot of garbage clean-ups, it is still nearly twice as fast
as the <code>cata</code> function! By the way, we can even get the amount of GCs down. Actually
there is no point in using an immutable stack. We also can use an mutable stack
in <code>fold</code>. This makes the implementation a little bit harder again.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs146', 736)" onmouseover="showTip(event, 'fs146', 736)" class="f">treeFoldStack</span> <span onmouseout="hideTip(event, 'fs116', 737)" onmouseover="showTip(event, 'fs116', 737)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs117', 738)" onmouseover="showTip(event, 'fs117', 738)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs69', 739)" onmouseover="showTip(event, 'fs69', 739)" class="i">tree</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs147', 740)" onmouseover="showTip(event, 'fs147', 740)" class="i">stack</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 741)" onmouseover="showTip(event, 'fs2', 741)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs148', 742)" onmouseover="showTip(event, 'fs148', 742)" class="i">Collections</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs149', 743)" onmouseover="showTip(event, 'fs149', 743)" class="i">Generic</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs150', 744)" onmouseover="showTip(event, 'fs150', 744)" class="t">Stack</span><span class="o">&lt;</span>_<span class="o">&gt;</span>()
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs151', 745)" onmouseover="showTip(event, 'fs151', 745)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 746)" onmouseover="showTip(event, 'fs117', 746)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs69', 747)" onmouseover="showTip(event, 'fs69', 747)" class="i">tree</span> <span class="o">=</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs69', 748)" onmouseover="showTip(event, 'fs69', 748)" class="i">tree</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs59', 749)" onmouseover="showTip(event, 'fs59', 749)" class="p">Leaf</span> <span class="k">-&gt;</span>
            <span class="k">if</span>   <span onmouseout="hideTip(event, 'fs147', 750)" onmouseover="showTip(event, 'fs147', 750)" class="i">stack</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs152', 751)" onmouseover="showTip(event, 'fs152', 751)" class="i">Count</span> <span class="o">&gt;</span> <span class="n">0</span>
            <span class="k">then</span> <span onmouseout="hideTip(event, 'fs151', 752)" onmouseover="showTip(event, 'fs151', 752)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 753)" onmouseover="showTip(event, 'fs117', 753)" class="i">acc</span> (<span onmouseout="hideTip(event, 'fs147', 754)" onmouseover="showTip(event, 'fs147', 754)" class="i">stack</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs153', 755)" onmouseover="showTip(event, 'fs153', 755)" class="f">Pop</span>())
            <span class="k">else</span> <span onmouseout="hideTip(event, 'fs117', 756)" onmouseover="showTip(event, 'fs117', 756)" class="i">acc</span>
        | <span onmouseout="hideTip(event, 'fs60', 757)" onmouseover="showTip(event, 'fs60', 757)" class="p">Node</span>(<span onmouseout="hideTip(event, 'fs70', 758)" onmouseover="showTip(event, 'fs70', 758)" class="i">x</span>,<span onmouseout="hideTip(event, 'fs71', 759)" onmouseover="showTip(event, 'fs71', 759)" class="i">l</span>,<span onmouseout="hideTip(event, 'fs72', 760)" onmouseover="showTip(event, 'fs72', 760)" class="i">r</span>) <span class="k">-&gt;</span>
            <span onmouseout="hideTip(event, 'fs147', 761)" onmouseover="showTip(event, 'fs147', 761)" class="i">stack</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs154', 762)" onmouseover="showTip(event, 'fs154', 762)" class="f">Push</span> <span onmouseout="hideTip(event, 'fs72', 763)" onmouseover="showTip(event, 'fs72', 763)" class="i">r</span>
            <span onmouseout="hideTip(event, 'fs151', 764)" onmouseover="showTip(event, 'fs151', 764)" class="f">loop</span> (<span onmouseout="hideTip(event, 'fs116', 765)" onmouseover="showTip(event, 'fs116', 765)" class="f">folder</span> <span onmouseout="hideTip(event, 'fs117', 766)" onmouseover="showTip(event, 'fs117', 766)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs70', 767)" onmouseover="showTip(event, 'fs70', 767)" class="i">x</span>) <span onmouseout="hideTip(event, 'fs71', 768)" onmouseover="showTip(event, 'fs71', 768)" class="i">l</span>
    <span onmouseout="hideTip(event, 'fs151', 769)" onmouseover="showTip(event, 'fs151', 769)" class="f">loop</span> <span onmouseout="hideTip(event, 'fs117', 770)" onmouseover="showTip(event, 'fs117', 770)" class="i">acc</span> <span onmouseout="hideTip(event, 'fs69', 771)" onmouseover="showTip(event, 'fs69', 771)" class="i">tree</span>
</code></pre></td>
</tr>
</table>
<p>Let's see how it compares to <code>treeFold</code></p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs135', 772)" onmouseover="showTip(event, 'fs135', 772)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs146', 773)" onmouseover="showTip(event, 'fs146', 773)" class="f">treeFoldStack</span> (<span class="o">+</span>) <span class="n">0</span> <span onmouseout="hideTip(event, 'fs133', 774)" onmouseover="showTip(event, 'fs133', 774)" class="i">smallL</span>)
<span class="c">// Real: 00:00:04.018, CPU: 00:00:04.015, GC gen0: 416, gen1: 416, gen2: 0</span>
<span class="c">// Real: 00:00:04.029, CPU: 00:00:04.015, GC gen0: 416, gen1: 416, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs135', 775)" onmouseover="showTip(event, 'fs135', 775)" class="f">bench</span> <span class="n">10000</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs146', 776)" onmouseover="showTip(event, 'fs146', 776)" class="f">treeFoldStack</span> (<span class="o">+</span>) <span class="n">0</span> <span onmouseout="hideTip(event, 'fs134', 777)" onmouseover="showTip(event, 'fs134', 777)" class="i">smallR</span>)
<span class="c">// Real: 00:00:04.000, CPU: 00:00:03.984, GC gen0: 0, gen1: 0, gen2: 0</span>
<span class="c">// Real: 00:00:03.994, CPU: 00:00:03.953, GC gen0: 0, gen1: 0, gen2: 0</span>
</code></pre></td>
</tr>
</table>
<p>Also, this is not what I expected, it becomes slower to the speed of the <code>cata</code> function. And
in the <code>smallL</code> case it still triggers a lot of GC clean-ups. On a tree only with right nodes
we don't have any clean-ups because we don't save anything in the stack. It is still quite interesting
to see that the timing with and without GC clean-ups are the same. So it seems the GC clean-ups are
so fast that they overall don't matter at all for the overall timing. At least on my machine.</p>
<p>So, how are the timings for really big but balanced trees? A balanced tree with a depth
of 25 contains 33.554.431 entries. How are the timings here?</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs155', 778)" onmouseover="showTip(event, 'fs155', 778)" class="i">balanced25</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs132', 779)" onmouseover="showTip(event, 'fs132', 779)" class="f">createBalanced</span> <span class="n">25</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs156', 780)" onmouseover="showTip(event, 'fs156', 780)" class="f">sum</span> <span onmouseout="hideTip(event, 'fs22', 781)" onmouseover="showTip(event, 'fs22', 781)" class="i">x</span> <span onmouseout="hideTip(event, 'fs84', 782)" onmouseover="showTip(event, 'fs84', 782)" class="i">l</span> <span onmouseout="hideTip(event, 'fs85', 783)" onmouseover="showTip(event, 'fs85', 783)" class="i">r</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs22', 784)" onmouseover="showTip(event, 'fs22', 784)" class="i">x</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs84', 785)" onmouseover="showTip(event, 'fs84', 785)" class="i">l</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs85', 786)" onmouseover="showTip(event, 'fs85', 786)" class="i">r</span>

<span onmouseout="hideTip(event, 'fs77', 787)" onmouseover="showTip(event, 'fs77', 787)" class="f">treeCata</span> <span onmouseout="hideTip(event, 'fs156', 788)" onmouseover="showTip(event, 'fs156', 788)" class="f">sum</span> <span onmouseout="hideTip(event, 'fs155', 789)" onmouseover="showTip(event, 'fs155', 789)" class="i">balanced25</span> <span class="n">0</span>
<span class="c">// Real: 00:00:01.242, CPU: 00:00:01.234, GC gen0: 0, gen1: 0, gen2: 0</span>
<span class="c">// Real: 00:00:01.239, CPU: 00:00:01.218, GC gen0: 0, gen1: 0, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs92', 790)" onmouseover="showTip(event, 'fs92', 790)" class="f">treeFoldBack</span> <span onmouseout="hideTip(event, 'fs156', 791)" onmouseover="showTip(event, 'fs156', 791)" class="f">sum</span> <span onmouseout="hideTip(event, 'fs155', 792)" onmouseover="showTip(event, 'fs155', 792)" class="i">balanced25</span> <span class="n">0</span>
<span class="c">// Real: 00:00:02.501, CPU: 00:00:02.500, GC gen0: 556, gen1: 555, gen2: 1</span>
<span class="c">// Real: 00:00:02.451, CPU: 00:00:02.453, GC gen0: 555, gen1: 555, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs122', 793)" onmouseover="showTip(event, 'fs122', 793)" class="f">treeFold</span> (<span class="o">+</span>) <span class="n">0</span> <span onmouseout="hideTip(event, 'fs155', 794)" onmouseover="showTip(event, 'fs155', 794)" class="i">balanced25</span>
<span class="c">// Real: 00:00:01.000, CPU: 00:00:00.968, GC gen0: 171, gen1: 171, gen2: 0</span>
<span class="c">// Real: 00:00:01.000, CPU: 00:00:01.000, GC gen0: 171, gen1: 171, gen2: 0</span>

<span onmouseout="hideTip(event, 'fs146', 795)" onmouseover="showTip(event, 'fs146', 795)" class="f">treeFoldStack</span> (<span class="o">+</span>) <span class="n">0</span> <span onmouseout="hideTip(event, 'fs155', 796)" onmouseover="showTip(event, 'fs155', 796)" class="i">balanced25</span>
<span class="c">// Real: 00:00:01.418, CPU: 00:00:01.421, GC gen0: 0, gen1: 0, gen2: 0</span>
<span class="c">// Real: 00:00:01.412, CPU: 00:00:01.406, GC gen0: 0, gen1: 0, gen2: 0</span>
</code></pre></td>
</tr>
</table>
<p>All in one, the <code>cata</code> function overall is usually the easiest to implement, in its performance it is
also quite good, at least better as a naive implementation with continuation functions. Because
most memory get handled by the stack, it also don't causes garbage collection.</p>
<p>An implementation with a mutable stack also can be efficient in terms of garbage collection, but at least
on my machine it is still slower compared to the pure recursive version.</p>
<p>As an overall result you shouldn't abandon the <code>cata</code> function, just because you fear that
non tail-recursive functions are automatically slower. Usually they are very easy to implement
and the speed is quite good. Instead you should consider if you expect problems with the stack depth.
When you create balanced trees this is quite uncommon that you run into problems with the stack depth.</p>
<p>But with a type like a list that has linear recursion, where every element increases the stack depth
by one, you should consider more time in writing tail-recursive functions.</p>
<a name="markdown"></a>
<h2>Markdown</h2>
<p>Up so far I only talked about lists and binary trees, but both types basically contain everything
you need to know. Any other type is basically just repetition of what was said so far. As a last
example I want to show the small Markdown example that I created in the
<a href="/blog/2016/04/26/algebraic-data-types">Algebraic-Data Types</a> article. It is not a full description of the Markdown definition,
but is good enough as an example.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs157', 797)" onmouseover="showTip(event, 'fs157', 797)" class="t">Markdown</span> <span class="o">=</span>
    | <span onmouseout="hideTip(event, 'fs158', 798)" onmouseover="showTip(event, 'fs158', 798)" class="p">NewLine</span>
    | <span onmouseout="hideTip(event, 'fs159', 799)" onmouseover="showTip(event, 'fs159', 799)" class="p">Literal</span>    <span class="k">of</span> <span onmouseout="hideTip(event, 'fs160', 800)" onmouseover="showTip(event, 'fs160', 800)" class="t">string</span>
    | <span onmouseout="hideTip(event, 'fs161', 801)" onmouseover="showTip(event, 'fs161', 801)" class="p">Bold</span>       <span class="k">of</span> <span onmouseout="hideTip(event, 'fs160', 802)" onmouseover="showTip(event, 'fs160', 802)" class="t">string</span>
    | <span onmouseout="hideTip(event, 'fs162', 803)" onmouseover="showTip(event, 'fs162', 803)" class="p">InlineCode</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs160', 804)" onmouseover="showTip(event, 'fs160', 804)" class="t">string</span>
    | <span onmouseout="hideTip(event, 'fs163', 805)" onmouseover="showTip(event, 'fs163', 805)" class="p">Block</span>      <span class="k">of</span> <span onmouseout="hideTip(event, 'fs157', 806)" onmouseover="showTip(event, 'fs157', 806)" class="t">Markdown</span> <span onmouseout="hideTip(event, 'fs41', 807)" onmouseover="showTip(event, 'fs41', 807)" class="t">list</span>
</code></pre></td>
</tr>
</table>
<p>Our Markdown definition contains 4 non-recursive cases and one recursive case. We just did what we did
so far. We create a <code>cata</code> function that expects a function for every case. As <code>NewLine</code> contains no
data, we can just expect a plain value.</p>
<p>The recursive element is quite different from what we have seen so far. Instead of a single recursive
element we have a list of recursive elements. But that shouldn't be much of a difference. We just
call the <code>recurs</code> function for every element in the list with <code>List.map</code>. Overall we end up
with the following <code>cata</code> function.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs164', 808)" onmouseover="showTip(event, 'fs164', 808)" class="f">markCata</span> <span onmouseout="hideTip(event, 'fs165', 809)" onmouseover="showTip(event, 'fs165', 809)" class="i">newline</span> <span onmouseout="hideTip(event, 'fs166', 810)" onmouseover="showTip(event, 'fs166', 810)" class="f">literal</span> <span onmouseout="hideTip(event, 'fs167', 811)" onmouseover="showTip(event, 'fs167', 811)" class="f">bold</span> <span onmouseout="hideTip(event, 'fs168', 812)" onmouseover="showTip(event, 'fs168', 812)" class="f">code</span> <span onmouseout="hideTip(event, 'fs169', 813)" onmouseover="showTip(event, 'fs169', 813)" class="f">block</span> <span onmouseout="hideTip(event, 'fs170', 814)" onmouseover="showTip(event, 'fs170', 814)" class="i">doc</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">r</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs171', 815)" onmouseover="showTip(event, 'fs171', 815)" class="f">recurs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs164', 816)" onmouseover="showTip(event, 'fs164', 816)" class="f">markCata</span> <span onmouseout="hideTip(event, 'fs165', 817)" onmouseover="showTip(event, 'fs165', 817)" class="i">newline</span> <span onmouseout="hideTip(event, 'fs166', 818)" onmouseover="showTip(event, 'fs166', 818)" class="f">literal</span> <span onmouseout="hideTip(event, 'fs167', 819)" onmouseover="showTip(event, 'fs167', 819)" class="f">bold</span> <span onmouseout="hideTip(event, 'fs168', 820)" onmouseover="showTip(event, 'fs168', 820)" class="f">code</span> <span onmouseout="hideTip(event, 'fs169', 821)" onmouseover="showTip(event, 'fs169', 821)" class="f">block</span>
    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs170', 822)" onmouseover="showTip(event, 'fs170', 822)" class="i">doc</span> <span class="k">with</span>
    | <span onmouseout="hideTip(event, 'fs158', 823)" onmouseover="showTip(event, 'fs158', 823)" class="p">NewLine</span>        <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs165', 824)" onmouseover="showTip(event, 'fs165', 824)" class="i">newline</span>
    | <span onmouseout="hideTip(event, 'fs159', 825)" onmouseover="showTip(event, 'fs159', 825)" class="p">Literal</span>    <span onmouseout="hideTip(event, 'fs172', 826)" onmouseover="showTip(event, 'fs172', 826)" class="i">str</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs166', 827)" onmouseover="showTip(event, 'fs166', 827)" class="f">literal</span> <span onmouseout="hideTip(event, 'fs172', 828)" onmouseover="showTip(event, 'fs172', 828)" class="i">str</span>
    | <span onmouseout="hideTip(event, 'fs161', 829)" onmouseover="showTip(event, 'fs161', 829)" class="p">Bold</span>       <span onmouseout="hideTip(event, 'fs172', 830)" onmouseover="showTip(event, 'fs172', 830)" class="i">str</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs167', 831)" onmouseover="showTip(event, 'fs167', 831)" class="f">bold</span> <span onmouseout="hideTip(event, 'fs172', 832)" onmouseover="showTip(event, 'fs172', 832)" class="i">str</span>
    | <span onmouseout="hideTip(event, 'fs162', 833)" onmouseover="showTip(event, 'fs162', 833)" class="p">InlineCode</span> <span onmouseout="hideTip(event, 'fs172', 834)" onmouseover="showTip(event, 'fs172', 834)" class="i">str</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs168', 835)" onmouseover="showTip(event, 'fs168', 835)" class="f">code</span> <span onmouseout="hideTip(event, 'fs172', 836)" onmouseover="showTip(event, 'fs172', 836)" class="i">str</span>
    | <span onmouseout="hideTip(event, 'fs163', 837)" onmouseover="showTip(event, 'fs163', 837)" class="p">Block</span>      <span onmouseout="hideTip(event, 'fs173', 838)" onmouseover="showTip(event, 'fs173', 838)" class="i">doc</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs169', 839)" onmouseover="showTip(event, 'fs169', 839)" class="f">block</span> (<span onmouseout="hideTip(event, 'fs4', 840)" onmouseover="showTip(event, 'fs4', 840)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs174', 841)" onmouseover="showTip(event, 'fs174', 841)" class="f">map</span> <span onmouseout="hideTip(event, 'fs171', 842)" onmouseover="showTip(event, 'fs171', 842)" class="f">recurs</span> <span onmouseout="hideTip(event, 'fs173', 843)" onmouseover="showTip(event, 'fs173', 843)" class="i">doc</span>)
</code></pre></td>
</tr>
</table>
<p>Do we need a <code>fold</code> or <code>foldBack</code>? Well, I don't know you, but I don't think we ever see a markdown
document that has some ten thousand of nested blocks so recursion becomes a problem. Probably even
a nesting more than 5 is already rare. So overall I think writing <code>fold</code> and <code>foldBack</code> is probably
just a waste of time. So let's once again write a function that turns a markdown document into
HTML.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs175', 844)" onmouseover="showTip(event, 'fs175', 844)" class="f">produceHtml</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs176', 845)" onmouseover="showTip(event, 'fs176', 845)" class="f">escape</span>         <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 846)" onmouseover="showTip(event, 'fs2', 846)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs177', 847)" onmouseover="showTip(event, 'fs177', 847)" class="i">Web</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs178', 848)" onmouseover="showTip(event, 'fs178', 848)" class="t">HttpUtility</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs179', 849)" onmouseover="showTip(event, 'fs179', 849)" class="f">HtmlEncode</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs180', 850)" onmouseover="showTip(event, 'fs180', 850)" class="f">wrap</span> <span onmouseout="hideTip(event, 'fs181', 851)" onmouseover="showTip(event, 'fs181', 851)" class="i">tag</span> <span onmouseout="hideTip(event, 'fs172', 852)" onmouseover="showTip(event, 'fs172', 852)" class="i">str</span>   <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 853)" onmouseover="showTip(event, 'fs95', 853)" class="f">sprintf</span> <span class="s">&quot;&lt;</span><span class="pf">%s</span><span class="s">&gt;</span><span class="pf">%s</span><span class="s">&lt;/</span><span class="pf">%s</span><span class="s">&gt;&quot;</span> <span onmouseout="hideTip(event, 'fs181', 854)" onmouseover="showTip(event, 'fs181', 854)" class="i">tag</span> <span onmouseout="hideTip(event, 'fs172', 855)" onmouseover="showTip(event, 'fs172', 855)" class="i">str</span> <span onmouseout="hideTip(event, 'fs181', 856)" onmouseover="showTip(event, 'fs181', 856)" class="i">tag</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs182', 857)" onmouseover="showTip(event, 'fs182', 857)" class="f">wrapEscape</span> <span onmouseout="hideTip(event, 'fs181', 858)" onmouseover="showTip(event, 'fs181', 858)" class="i">tag</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs180', 859)" onmouseover="showTip(event, 'fs180', 859)" class="f">wrap</span> <span onmouseout="hideTip(event, 'fs181', 860)" onmouseover="showTip(event, 'fs181', 860)" class="i">tag</span> <span class="o">&lt;&lt;</span> <span onmouseout="hideTip(event, 'fs176', 861)" onmouseover="showTip(event, 'fs176', 861)" class="f">escape</span>
    <span onmouseout="hideTip(event, 'fs164', 862)" onmouseover="showTip(event, 'fs164', 862)" class="f">markCata</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span onmouseout="hideTip(event, 'fs176', 863)" onmouseover="showTip(event, 'fs176', 863)" class="f">escape</span> (<span onmouseout="hideTip(event, 'fs182', 864)" onmouseover="showTip(event, 'fs182', 864)" class="f">wrapEscape</span> <span class="s">&quot;strong&quot;</span>) (<span onmouseout="hideTip(event, 'fs182', 865)" onmouseover="showTip(event, 'fs182', 865)" class="f">wrapEscape</span> <span class="s">&quot;code&quot;</span>) (<span onmouseout="hideTip(event, 'fs180', 866)" onmouseover="showTip(event, 'fs180', 866)" class="f">wrap</span> <span class="s">&quot;p&quot;</span> <span class="o">&lt;&lt;</span> <span onmouseout="hideTip(event, 'fs23', 867)" onmouseover="showTip(event, 'fs23', 867)" class="t">String</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs114', 868)" onmouseover="showTip(event, 'fs114', 868)" class="f">concat</span> <span class="s">&quot;&quot;</span>)
</code></pre></td>
</tr>
</table>
<p>Probably there isn't much to say here. The <code>escape</code> function correctly escapes HTML characters.
As I always need to wrap string into tags I just created a <code>wrap</code> function that I can pass a
<em>tag</em> and a <em>string</em> that does that. But I need a version that escapes the string, and one that
doesn't. The last one is important for a recursive case. Because we don't want to escape the HTML
tags itself. The arguments of the <code>wrap</code> and <code>wrapEscape</code> function are chosen in a way so I can
use currying, so I don't need to create a lot of lambda expressions.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs183', 869)" onmouseover="showTip(event, 'fs183', 869)" class="i">document</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs163', 870)" onmouseover="showTip(event, 'fs163', 870)" class="p">Block</span> [
        <span onmouseout="hideTip(event, 'fs159', 871)" onmouseover="showTip(event, 'fs159', 871)" class="p">Literal</span> <span class="s">&quot;Hello&quot;</span>; <span onmouseout="hideTip(event, 'fs161', 872)" onmouseover="showTip(event, 'fs161', 872)" class="p">Bold</span> <span class="s">&quot;World!&quot;</span>; <span onmouseout="hideTip(event, 'fs158', 873)" onmouseover="showTip(event, 'fs158', 873)" class="p">NewLine</span>
        <span onmouseout="hideTip(event, 'fs159', 874)" onmouseover="showTip(event, 'fs159', 874)" class="p">Literal</span> <span class="s">&quot;InlineCode of&quot;</span>; <span onmouseout="hideTip(event, 'fs162', 875)" onmouseover="showTip(event, 'fs162', 875)" class="p">InlineCode</span> <span class="s">&quot;let sum x y = x + y&quot;</span>; <span onmouseout="hideTip(event, 'fs158', 876)" onmouseover="showTip(event, 'fs158', 876)" class="p">NewLine</span>
        <span onmouseout="hideTip(event, 'fs163', 877)" onmouseover="showTip(event, 'fs163', 877)" class="p">Block</span> [
            <span onmouseout="hideTip(event, 'fs159', 878)" onmouseover="showTip(event, 'fs159', 878)" class="p">Literal</span> <span class="s">&quot;This is the end with some &lt;html&gt;that should be escaped&lt;/html&gt;&quot;</span>
        ]
    ]

<span onmouseout="hideTip(event, 'fs175', 879)" onmouseover="showTip(event, 'fs175', 879)" class="f">produceHtml</span> <span onmouseout="hideTip(event, 'fs183', 880)" onmouseover="showTip(event, 'fs183', 880)" class="i">document</span>
<span class="c">// &quot;&lt;p&gt;Hello&lt;strong&gt;World!&lt;/strong&gt;&lt;br/&gt;InlineCode of&lt;code&gt;let sum x y = x + y&lt;/code&gt;&lt;br/&gt;</span>
<span class="c">//  &lt;p&gt;This is the end with some &amp;lt;html&amp;gt;that should be escaped&amp;lt;/html&amp;gt;&lt;/p&gt;&lt;/p&gt;&quot;</span>
</code></pre></td>
</tr>
</table>
<a name="summary"></a>
<h2>Summary</h2>
<p>We have seen how to create a <code>cata</code> function, and we learned that <code>foldBack</code> is just <code>cata</code>
written tail-recursive. For the <code>fold</code> implementation of the tree, i choosed another way to
create a tail-recursive function that manages the stack directly.</p>
<p>In benchmarking we also saw that the last way is also quite better in terms of speed and
garbage collection compared to a continuation approach. With a mutable stack we can even further
eliminate garbage collection cleanup.</p>
<p>But overall we have seen that <code>cata</code> is very fast and it doesn't mean that tail-recursion
is automatically better or faster.</p>
<a name="further"></a>
<h2>Further Reading</h2>
<ul>
<li><a href="http://fsharpforfunandprofit.com/series/recursive-types-and-folds.html">Recursive types and folds</a></li>
<li><a href="https://lorgonblog.wordpress.com/2008/04/05/catamorphisms-part-one/">Catamorphisms, part one</a></li>
</ul>
<a name="comments"></a>


<div class="tip" id="fs1">module Main</div>
<div class="tip" id="fs2">namespace System</div>
<div class="tip" id="fs3">namespace System.Diagnostics</div>
<div class="tip" id="fs4">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;a&gt; =<br />&#160;&#160;| Empty<br />&#160;&#160;| Cons of head: &#39;a * tail: List&lt;&#39;a&gt;<br /><br />Full name: Main.List&lt;_&gt;</div>
<div class="tip" id="fs5">union case List.Empty: List&lt;&#39;a&gt;</div>
<div class="tip" id="fs6">union case List.Cons: head: &#39;a * tail: List&lt;&#39;a&gt; -&gt; List&lt;&#39;a&gt;</div>
<div class="tip" id="fs7">val empty : List&lt;&#39;a&gt;<br /><br />Full name: Main.empty</div>
<div class="tip" id="fs8">val cons : h:&#39;a -&gt; t:List&lt;&#39;a&gt; -&gt; List&lt;&#39;a&gt;<br /><br />Full name: Main.cons</div>
<div class="tip" id="fs9">val h : &#39;a</div>
<div class="tip" id="fs10">val t : List&lt;&#39;a&gt;</div>
<div class="tip" id="fs11">val xs : obj<br /><br />Full name: catamorphisms.xs</div>
<div class="tip" id="fs12">val l1 : List&lt;int&gt;<br /><br />Full name: Main.l1</div>
<div class="tip" id="fs13">val l2 : List&lt;int&gt;<br /><br />Full name: Main.l2</div>
<div class="tip" id="fs14">val l3 : List&lt;string&gt;<br /><br />Full name: Main.l3</div>
<div class="tip" id="fs15">val listLength&#39; : list:List&lt;&#39;a&gt; -&gt; int<br /><br />Full name: Main.listLength&#39;</div>
<div class="tip" id="fs16">Multiple items<br />val list : List&lt;&#39;a&gt;<br /><br />--------------------<br />type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs17">val listSum&#39; : _arg1:List&lt;int&gt; -&gt; int<br /><br />Full name: Main.listSum&#39;</div>
<div class="tip" id="fs18">val h : int</div>
<div class="tip" id="fs19">val t : List&lt;int&gt;</div>
<div class="tip" id="fs20">val listMap&#39; : f:(&#39;a -&gt; &#39;b) -&gt; _arg1:List&lt;&#39;a&gt; -&gt; List&lt;&#39;b&gt;<br /><br />Full name: Main.listMap&#39;</div>
<div class="tip" id="fs21">val f : (&#39;a -&gt; &#39;b)</div>
<div class="tip" id="fs22">val x : int</div>
<div class="tip" id="fs23">module String<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs24">val length : str:string -&gt; int<br /><br />Full name: Microsoft.FSharp.Core.String.length</div>
<div class="tip" id="fs25">val listSnoc&#39; : x:&#39;a -&gt; _arg1:List&lt;&#39;a&gt; -&gt; List&lt;&#39;a&gt;<br /><br />Full name: Main.listSnoc&#39;</div>
<div class="tip" id="fs26">val x : &#39;a</div>
<div class="tip" id="fs27">val listCata&#39; : fEmpty:(unit -&gt; &#39;a) -&gt; fCons:(&#39;b -&gt; &#39;a -&gt; &#39;a) -&gt; _arg1:List&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.listCata&#39;</div>
<div class="tip" id="fs28">val fEmpty : (unit -&gt; &#39;a)</div>
<div class="tip" id="fs29">val fCons : (&#39;b -&gt; &#39;a -&gt; &#39;a)</div>
<div class="tip" id="fs30">val h : &#39;b</div>
<div class="tip" id="fs31">val t : List&lt;&#39;b&gt;</div>
<div class="tip" id="fs32">val listLength&#39;&#39; : list:List&lt;&#39;a&gt; -&gt; int<br /><br />Full name: Main.listLength&#39;&#39;</div>
<div class="tip" id="fs33">val t : int</div>
<div class="tip" id="fs34">val listCata&#39;&#39; : fEmpty:(unit -&gt; &#39;a) -&gt; fCons:(&#39;b -&gt; &#39;a -&gt; &#39;a) -&gt; list:List&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.listCata&#39;&#39;</div>
<div class="tip" id="fs35">Multiple items<br />val list : List&lt;&#39;b&gt;<br /><br />--------------------<br />type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs36">val recurs : (List&lt;&#39;b&gt; -&gt; &#39;a)</div>
<div class="tip" id="fs37">val listCata&#39;&#39;&#39; : empty:&#39;State -&gt; fCons:(&#39;a -&gt; &#39;State -&gt; &#39;State) -&gt; list:List&lt;&#39;a&gt; -&gt; &#39;State<br /><br />Full name: Main.listCata&#39;&#39;&#39;</div>
<div class="tip" id="fs38">val empty : &#39;State</div>
<div class="tip" id="fs39">val fCons : (&#39;a -&gt; &#39;State -&gt; &#39;State)</div>
<div class="tip" id="fs40">val recurs : (List&lt;&#39;a&gt; -&gt; &#39;State)</div>
<div class="tip" id="fs41">type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs42">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member GetSlice : startIndex:int option * endIndex:int option -&gt; &#39;T list<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs43">val listCata : fCons:(&#39;a -&gt; &#39;State -&gt; &#39;State) -&gt; list:List&lt;&#39;a&gt; -&gt; state:&#39;State -&gt; &#39;State<br /><br />Full name: Main.listCata</div>
<div class="tip" id="fs44">val state : &#39;State</div>
<div class="tip" id="fs45">val listLength : list:List&lt;&#39;a&gt; -&gt; int<br /><br />Full name: Main.listLength</div>
<div class="tip" id="fs46">val acc : int</div>
<div class="tip" id="fs47">val listSum : list:List&lt;int&gt; -&gt; int<br /><br />Full name: Main.listSum</div>
<div class="tip" id="fs48">Multiple items<br />val list : List&lt;int&gt;<br /><br />--------------------<br />type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs49">val listMap : f:(&#39;a -&gt; &#39;b) -&gt; list:List&lt;&#39;a&gt; -&gt; List&lt;&#39;b&gt;<br /><br />Full name: Main.listMap</div>
<div class="tip" id="fs50">val acc : List&lt;&#39;b&gt;</div>
<div class="tip" id="fs51">val listSnoc : x:&#39;a -&gt; list:List&lt;&#39;a&gt; -&gt; List&lt;&#39;a&gt;<br /><br />Full name: Main.listSnoc</div>
<div class="tip" id="fs52">val acc : List&lt;&#39;a&gt;</div>
<div class="tip" id="fs53">val listFoldBack : fCons:(&#39;a -&gt; &#39;State -&gt; &#39;State) -&gt; list:List&lt;&#39;a&gt; -&gt; state:&#39;State -&gt; &#39;State<br /><br />Full name: Main.listFoldBack</div>
<div class="tip" id="fs54">val loop : (List&lt;&#39;a&gt; -&gt; (&#39;State -&gt; &#39;b) -&gt; &#39;b)</div>
<div class="tip" id="fs55">val cont : (&#39;State -&gt; &#39;b)</div>
<div class="tip" id="fs56">val racc : &#39;State</div>
<div class="tip" id="fs57">val id : x:&#39;T -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.id</div>
<div class="tip" id="fs58">type Tree&lt;&#39;a&gt; =<br />&#160;&#160;| Leaf<br />&#160;&#160;| Node of &#39;a * Tree&lt;&#39;a&gt; * Tree&lt;&#39;a&gt;<br /><br />Full name: Main.Tree&lt;_&gt;</div>
<div class="tip" id="fs59">union case Tree.Leaf: Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs60">union case Tree.Node: &#39;a * Tree&lt;&#39;a&gt; * Tree&lt;&#39;a&gt; -&gt; Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs61">val node : x:&#39;a -&gt; l:Tree&lt;&#39;a&gt; -&gt; r:Tree&lt;&#39;a&gt; -&gt; Tree&lt;&#39;a&gt;<br /><br />Full name: Main.node</div>
<div class="tip" id="fs62">val l : Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs63">val r : Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs64">val endNode : x:&#39;a -&gt; Tree&lt;&#39;a&gt;<br /><br />Full name: Main.endNode</div>
<div class="tip" id="fs65">val tree : Tree&lt;int&gt;<br /><br />Full name: Main.tree</div>
<div class="tip" id="fs66">val treeCata&#39; : fLeaf:(unit -&gt; &#39;a) -&gt; fNode:(&#39;b -&gt; &#39;a -&gt; &#39;a -&gt; &#39;a) -&gt; tree:Tree&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.treeCata&#39;</div>
<div class="tip" id="fs67">val fLeaf : (unit -&gt; &#39;a)</div>
<div class="tip" id="fs68">val fNode : (&#39;b -&gt; &#39;a -&gt; &#39;a -&gt; &#39;a)</div>
<div class="tip" id="fs69">val tree : Tree&lt;&#39;b&gt;</div>
<div class="tip" id="fs70">val x : &#39;b</div>
<div class="tip" id="fs71">val l : Tree&lt;&#39;b&gt;</div>
<div class="tip" id="fs72">val r : Tree&lt;&#39;b&gt;</div>
<div class="tip" id="fs73">val treeCata&#39;&#39; : fLeaf:(unit -&gt; &#39;a) -&gt; fNode:(&#39;b -&gt; &#39;a -&gt; &#39;a -&gt; &#39;a) -&gt; tree:Tree&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.treeCata&#39;&#39;</div>
<div class="tip" id="fs74">val recurs : (Tree&lt;&#39;b&gt; -&gt; &#39;a)</div>
<div class="tip" id="fs75">val treeCata&#39;&#39;&#39; : leaf:&#39;a -&gt; fNode:(&#39;b -&gt; &#39;a -&gt; &#39;a -&gt; &#39;a) -&gt; tree:Tree&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.treeCata&#39;&#39;&#39;</div>
<div class="tip" id="fs76">val leaf : &#39;a</div>
<div class="tip" id="fs77">val treeCata : folder:(&#39;a -&gt; &#39;State -&gt; &#39;State -&gt; &#39;State) -&gt; tree:Tree&lt;&#39;a&gt; -&gt; acc:&#39;State -&gt; &#39;State<br /><br />Full name: Main.treeCata</div>
<div class="tip" id="fs78">val folder : (&#39;a -&gt; &#39;State -&gt; &#39;State -&gt; &#39;State)</div>
<div class="tip" id="fs79">val tree : Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs80">val acc : &#39;State</div>
<div class="tip" id="fs81">val recurs : (Tree&lt;&#39;a&gt; -&gt; &#39;State)</div>
<div class="tip" id="fs82">val t : Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs83">val treeLength : tree:Tree&lt;&#39;a&gt; -&gt; int<br /><br />Full name: Main.treeLength</div>
<div class="tip" id="fs84">val l : int</div>
<div class="tip" id="fs85">val r : int</div>
<div class="tip" id="fs86">val treeSum : tree:Tree&lt;int&gt; -&gt; int<br /><br />Full name: Main.treeSum</div>
<div class="tip" id="fs87">val tree : Tree&lt;int&gt;</div>
<div class="tip" id="fs88">val treeMap : f:(&#39;a -&gt; &#39;b) -&gt; tree:Tree&lt;&#39;a&gt; -&gt; Tree&lt;&#39;b&gt;<br /><br />Full name: Main.treeMap</div>
<div class="tip" id="fs89">val fold : folder:(&#39;State -&gt; &#39;T -&gt; &#39;State) -&gt; state:&#39;State -&gt; list:&#39;T list -&gt; &#39;State<br /><br />Full name: Microsoft.FSharp.Collections.List.fold</div>
<div class="tip" id="fs90">val mutable acc : int<br /><br />Full name: Main.acc</div>
<div class="tip" id="fs91">val foldBack : folder:(&#39;T -&gt; &#39;State -&gt; &#39;State) -&gt; list:&#39;T list -&gt; state:&#39;State -&gt; &#39;State<br /><br />Full name: Microsoft.FSharp.Collections.List.foldBack</div>
<div class="tip" id="fs92">val treeFoldBack : folder:(&#39;a -&gt; &#39;State -&gt; &#39;State -&gt; &#39;State) -&gt; tree:Tree&lt;&#39;a&gt; -&gt; acc:&#39;State -&gt; &#39;State<br /><br />Full name: Main.treeFoldBack</div>
<div class="tip" id="fs93">val loop : (Tree&lt;&#39;a&gt; -&gt; (&#39;State -&gt; &#39;b) -&gt; &#39;b)</div>
<div class="tip" id="fs94">val lacc : &#39;State</div>
<div class="tip" id="fs95">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs96">val ordered : int list<br /><br />Full name: Main.ordered</div>
<div class="tip" id="fs97">val l : int list</div>
<div class="tip" id="fs98">val r : int list</div>
<div class="tip" id="fs99">val reversed : int list<br /><br />Full name: Main.reversed</div>
<div class="tip" id="fs100">val preOrder : int list<br /><br />Full name: Main.preOrder</div>
<div class="tip" id="fs101">val postOrder : int list<br /><br />Full name: Main.postOrder</div>
<div class="tip" id="fs102">val path : search:&#39;a -&gt; tree:Tree&lt;&#39;a&gt; -&gt; string (requires equality)<br /><br />Full name: Main.path</div>
<div class="tip" id="fs103">val search : &#39;a (requires equality)</div>
<div class="tip" id="fs104">val tree : Tree&lt;&#39;a&gt; (requires equality)</div>
<div class="tip" id="fs105">val leaf : bool * &#39;b list</div>
<div class="tip" id="fs106">val node : (&#39;a -&gt; bool * string list -&gt; bool * string list -&gt; bool * string list) (requires equality)</div>
<div class="tip" id="fs107">val x : &#39;a (requires equality)</div>
<div class="tip" id="fs108">val lb : bool</div>
<div class="tip" id="fs109">val lp : string list</div>
<div class="tip" id="fs110">val rb : bool</div>
<div class="tip" id="fs111">val rp : string list</div>
<div class="tip" id="fs112">val path : bool * string list</div>
<div class="tip" id="fs113">val p : string list</div>
<div class="tip" id="fs114">val concat : sep:string -&gt; strings:seq&lt;string&gt; -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.String.concat</div>
<div class="tip" id="fs115">val treeFold&#39; : folder:(&#39;a -&gt; &#39;b -&gt; &#39;a) -&gt; acc:&#39;a -&gt; tree:Tree&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.treeFold&#39;</div>
<div class="tip" id="fs116">val folder : (&#39;a -&gt; &#39;b -&gt; &#39;a)</div>
<div class="tip" id="fs117">val acc : &#39;a</div>
<div class="tip" id="fs118">val loop : (&#39;a -&gt; Tree&lt;&#39;b&gt; list -&gt; Tree&lt;&#39;b&gt; -&gt; &#39;a)</div>
<div class="tip" id="fs119">val stack : Tree&lt;&#39;b&gt; list</div>
<div class="tip" id="fs120">val acc : unit</div>
<div class="tip" id="fs121">val printf : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printf</div>
<div class="tip" id="fs122">val treeFold : folder:(&#39;a -&gt; &#39;b -&gt; &#39;a) -&gt; acc:&#39;a -&gt; tree:Tree&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.treeFold</div>
<div class="tip" id="fs123">val createTree : builder:(&#39;a -&gt; &#39;a) -&gt; init:&#39;a -&gt; depth:int -&gt; &#39;a<br /><br />Full name: Main.createTree</div>
<div class="tip" id="fs124">val builder : (&#39;a -&gt; &#39;a)</div>
<div class="tip" id="fs125">val init : &#39;a</div>
<div class="tip" id="fs126">val depth : int</div>
<div class="tip" id="fs127">val loop : (int -&gt; &#39;a -&gt; &#39;a)</div>
<div class="tip" id="fs128">val count : int</div>
<div class="tip" id="fs129">val tree : &#39;a</div>
<div class="tip" id="fs130">val createLeftTree : (int -&gt; Tree&lt;int&gt;)<br /><br />Full name: Main.createLeftTree</div>
<div class="tip" id="fs131">val createRightTree : (int -&gt; Tree&lt;int&gt;)<br /><br />Full name: Main.createRightTree</div>
<div class="tip" id="fs132">val createBalanced : (int -&gt; Tree&lt;int&gt;)<br /><br />Full name: Main.createBalanced</div>
<div class="tip" id="fs133">val smallL : Tree&lt;int&gt;<br /><br />Full name: Main.smallL</div>
<div class="tip" id="fs134">val smallR : Tree&lt;int&gt;<br /><br />Full name: Main.smallR</div>
<div class="tip" id="fs135">val bench : times:int -&gt; f:(unit -&gt; &#39;a) -&gt; unit<br /><br />Full name: Main.bench</div>
<div class="tip" id="fs136">val times : int</div>
<div class="tip" id="fs137">val f : (unit -&gt; &#39;a)</div>
<div class="tip" id="fs138">val sw : Stopwatch</div>
<div class="tip" id="fs139">Multiple items<br />type Stopwatch =<br />&#160;&#160;new : unit -&gt; Stopwatch<br />&#160;&#160;member Elapsed : TimeSpan<br />&#160;&#160;member ElapsedMilliseconds : int64<br />&#160;&#160;member ElapsedTicks : int64<br />&#160;&#160;member IsRunning : bool<br />&#160;&#160;member Reset : unit -&gt; unit<br />&#160;&#160;member Restart : unit -&gt; unit<br />&#160;&#160;member Start : unit -&gt; unit<br />&#160;&#160;member Stop : unit -&gt; unit<br />&#160;&#160;static val Frequency : int64<br />&#160;&#160;...<br /><br />Full name: System.Diagnostics.Stopwatch<br /><br />--------------------<br />Stopwatch() : unit</div>
<div class="tip" id="fs140">Stopwatch.StartNew() : Stopwatch</div>
<div class="tip" id="fs141">val i : int32</div>
<div class="tip" id="fs142">val ignore : value:&#39;T -&gt; unit<br /><br />Full name: Microsoft.FSharp.Core.Operators.ignore</div>
<div class="tip" id="fs143">Stopwatch.Stop() : unit</div>
<div class="tip" id="fs144">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs145">property Stopwatch.Elapsed: System.TimeSpan</div>
<div class="tip" id="fs146">val treeFoldStack : folder:(&#39;a -&gt; &#39;b -&gt; &#39;a) -&gt; acc:&#39;a -&gt; tree:Tree&lt;&#39;b&gt; -&gt; &#39;a<br /><br />Full name: Main.treeFoldStack</div>
<div class="tip" id="fs147">val stack : System.Collections.Generic.Stack&lt;Tree&lt;&#39;b&gt;&gt;</div>
<div class="tip" id="fs148">namespace System.Collections</div>
<div class="tip" id="fs149">namespace System.Collections.Generic</div>
<div class="tip" id="fs150">Multiple items<br />type Stack&lt;&#39;T&gt; =<br />&#160;&#160;new : unit -&gt; Stack&lt;&#39;T&gt; + 2 overloads<br />&#160;&#160;member Clear : unit -&gt; unit<br />&#160;&#160;member Contains : item:&#39;T -&gt; bool<br />&#160;&#160;member CopyTo : array:&#39;T[] * arrayIndex:int -&gt; unit<br />&#160;&#160;member Count : int<br />&#160;&#160;member GetEnumerator : unit -&gt; Enumerator&lt;&#39;T&gt;<br />&#160;&#160;member Peek : unit -&gt; &#39;T<br />&#160;&#160;member Pop : unit -&gt; &#39;T<br />&#160;&#160;member Push : item:&#39;T -&gt; unit<br />&#160;&#160;member ToArray : unit -&gt; &#39;T[]<br />&#160;&#160;...<br />&#160;&#160;nested type Enumerator<br /><br />Full name: System.Collections.Generic.Stack&lt;_&gt;<br /><br />--------------------<br />System.Collections.Generic.Stack() : unit<br />System.Collections.Generic.Stack(capacity: int) : unit<br />System.Collections.Generic.Stack(collection: System.Collections.Generic.IEnumerable&lt;&#39;T&gt;) : unit</div>
<div class="tip" id="fs151">val loop : (&#39;a -&gt; Tree&lt;&#39;b&gt; -&gt; &#39;a)</div>
<div class="tip" id="fs152">property System.Collections.Generic.Stack.Count: int</div>
<div class="tip" id="fs153">System.Collections.Generic.Stack.Pop() : Tree&lt;&#39;b&gt;</div>
<div class="tip" id="fs154">System.Collections.Generic.Stack.Push(item: Tree&lt;&#39;b&gt;) : unit</div>
<div class="tip" id="fs155">val balanced25 : Tree&lt;int&gt;<br /><br />Full name: Main.balanced25</div>
<div class="tip" id="fs156">val sum : x:int -&gt; l:int -&gt; r:int -&gt; int<br /><br />Full name: Main.sum</div>
<div class="tip" id="fs157">type Markdown =<br />&#160;&#160;| NewLine<br />&#160;&#160;| Literal of string<br />&#160;&#160;| Bold of string<br />&#160;&#160;| InlineCode of string<br />&#160;&#160;| Block of Markdown list<br /><br />Full name: Main.Markdown</div>
<div class="tip" id="fs158">union case Markdown.NewLine: Markdown</div>
<div class="tip" id="fs159">Multiple items<br />union case Markdown.Literal: string -&gt; Markdown<br /><br />--------------------<br />type LiteralAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : unit -&gt; LiteralAttribute<br /><br />Full name: Microsoft.FSharp.Core.LiteralAttribute<br /><br />--------------------<br />new : unit -&gt; LiteralAttribute</div>
<div class="tip" id="fs160">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs161">union case Markdown.Bold: string -&gt; Markdown</div>
<div class="tip" id="fs162">union case Markdown.InlineCode: string -&gt; Markdown</div>
<div class="tip" id="fs163">union case Markdown.Block: Markdown list -&gt; Markdown</div>
<div class="tip" id="fs164">val markCata : newline:&#39;r -&gt; literal:(string -&gt; &#39;r) -&gt; bold:(string -&gt; &#39;r) -&gt; code:(string -&gt; &#39;r) -&gt; block:(&#39;r list -&gt; &#39;r) -&gt; doc:Markdown -&gt; &#39;r<br /><br />Full name: Main.markCata</div>
<div class="tip" id="fs165">val newline : &#39;r</div>
<div class="tip" id="fs166">val literal : (string -&gt; &#39;r)</div>
<div class="tip" id="fs167">val bold : (string -&gt; &#39;r)</div>
<div class="tip" id="fs168">val code : (string -&gt; &#39;r)</div>
<div class="tip" id="fs169">val block : (&#39;r list -&gt; &#39;r)</div>
<div class="tip" id="fs170">val doc : Markdown</div>
<div class="tip" id="fs171">val recurs : (Markdown -&gt; &#39;r)</div>
<div class="tip" id="fs172">val str : string</div>
<div class="tip" id="fs173">val doc : Markdown list</div>
<div class="tip" id="fs174">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; list:&#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.map</div>
<div class="tip" id="fs175">val produceHtml : (Markdown -&gt; string)<br /><br />Full name: Main.produceHtml</div>
<div class="tip" id="fs176">val escape : (string -&gt; string)</div>
<div class="tip" id="fs177">namespace System.Web</div>
<div class="tip" id="fs178">Multiple items<br />type HttpUtility =<br />&#160;&#160;new : unit -&gt; HttpUtility<br />&#160;&#160;static member HtmlAttributeEncode : s:string -&gt; string + 1 overload<br />&#160;&#160;static member HtmlDecode : s:string -&gt; string + 1 overload<br />&#160;&#160;static member HtmlEncode : s:string -&gt; string + 2 overloads<br />&#160;&#160;static member JavaScriptStringEncode : value:string -&gt; string + 1 overload<br />&#160;&#160;static member ParseQueryString : query:string -&gt; NameValueCollection + 1 overload<br />&#160;&#160;static member UrlDecode : str:string -&gt; string + 3 overloads<br />&#160;&#160;static member UrlDecodeToBytes : str:string -&gt; byte[] + 3 overloads<br />&#160;&#160;static member UrlEncode : str:string -&gt; string + 3 overloads<br />&#160;&#160;static member UrlEncodeToBytes : str:string -&gt; byte[] + 3 overloads<br />&#160;&#160;...<br /><br />Full name: System.Web.HttpUtility<br /><br />--------------------<br />System.Web.HttpUtility() : unit</div>
<div class="tip" id="fs179">System.Web.HttpUtility.HtmlEncode(value: obj) : string<br />System.Web.HttpUtility.HtmlEncode(s: string) : string<br />System.Web.HttpUtility.HtmlEncode(s: string, output: System.IO.TextWriter) : unit</div>
<div class="tip" id="fs180">val wrap : (string -&gt; string -&gt; string)</div>
<div class="tip" id="fs181">val tag : string</div>
<div class="tip" id="fs182">val wrapEscape : (string -&gt; string -&gt; string)</div>
<div class="tip" id="fs183">val document : Markdown<br /><br />Full name: Main.document</div>

</div>

<div class="related">
  <h2>Related Posts</h2>

  
  
  

  <ul class="related-posts">
  
    
    

    
  
    
    

    
      <li><h3><a href="https://sidburn.github.io/blog/2017/03/19/understanding-fold">Understanding Fold</a></h3></li>
      
      
    
  
    
    

    
      <li><h3><a href="https://sidburn.github.io/blog/2017/03/13/variable-arguments">Variable Arguments in F#</a></h3></li>
      
      
    
  
    
    

    
      <li><h3><a href="https://sidburn.github.io/blog/2017/02/27/mutability-vs-immutability-validation">Mutability vs. Immutability: Valid objects</a></h3></li>
      
      
    
  
    
    

    
      <li><h3><a href="https://sidburn.github.io/blog/2016/09/25/function-application-and-composition">Function Application and Composition</a></h3></li>
      
      
    
  
    
    

    
  
    
    

    
      <li><h3><a href="https://sidburn.github.io/blog/2016/05/24/monoids">Monoids</a></h3></li>
      
      
        
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
    this.page.title = "Catamorphisms"
    this.page.url = "http://sidburn.github.io/blog/2016/05/28/catamorphisms";
    this.page.identifier = "/blog/2016/05/28/catamorphisms";
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//davidraab.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74950849-1', 'auto');
  ga('send', 'pageview');
</script>
    <script id="dsq-count-scr" src="https://davidraab.disqus.com/count.js" async></script>
  </body>
</html>
